<link href="~/Content/Scripts/plugins/sweetalert2/dist/sweetalert2.min.css" rel="stylesheet" />

<div class="card">
    <div class="card-body">
        <h4 class="card-title">Tindakan Pencegahan</h4>
        <div>
            <table class="table table-hover table-bordered zero-configuration" style="color: black" id="Tbl_Pencegahan">
                <thead>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>Tindakan Perbaikan</th>
                        <th>Tindakan Pencegahan</th>
                        <th>Nama Pelaksana</th>
                        <th>Due_Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

@*Hidden Input*@
<input class="form-control form-control-sm" type="text" id="input_NIK" value="@Request.QueryString["NIK"]" hidden />

<script src="~/Content/Scripts/plugins/sweetalert2/dist/sweetalert2.min.js" defer></script>

<script>
    var isHide = false;
    function GetTindakanPencegahanPV() {
        var dictlist = {
            NoCAPA: $('#input_NoCAPA').val(),
            Option: 3,            
            NIK: $('#input_NIK').val()
        }
        var dto1 = {
            Model: dictlist
        }
        $.ajax({
            url: '../Koordinator/DynamicController?spname=SP_SHOW_Tindakan_PV',
            type: 'post',
            data: JSON.stringify(dto1),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var table = $('#Tbl_Pencegahan').DataTable({
                    "pageLength": 5,
                    "lengthChange": false,
                    "info": false,
                    "searching": false,
                    "paging": false,
                    "data": JSON.parse(data),
                    "select": true,
                    "scrollCollapse": true,
                    "destroy": true,
                    "columns": [
                        { "data": "RecordID" },
                        { "data": "WhyID" },
                        { "data": "WhyParentID" },
                        { "data": "WhyDesc" },
                        { "data": "Tindakan_Pencegahan" },
                        { "data": "Nama_Personil" },
                        { "data": "Due_Date" },
                        {
                            "data": null,
                            "defaultContent": "<button class='btn btn-danger delete' type='button' name='delete'>Delete</button> ",
                            "visible": (!isHide) ? (true) : (false)
                        }
                    ],
                    "columnDefs": [
                        {
                            "targets": [0],
                            "visible": false
                        },
                        {
                            "targets": [1],
                            "visible": false
                        },
                        {
                            "targets": [2],
                            "visible": false
                        }
                    ],
                    "order": [[1, 'asc']],
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function DeleteTindakanPencegahanPV() {
        $(document).on("click", "#Tbl_Pencegahan button.delete", function () {
            var rows = $(this).closest('tr');            
            var data = $('#Tbl_Pencegahan').DataTable().row(rows).data();

            var dictlist = {
                NoCAPA: $('#input_NoCAPA').val(),
                Option: 6,
                RecordID : data.RecordID
            }
            var dto1 = {
                Model: dictlist
            }
            
            $.ajax({
                url: '../Koordinator/DynamicController?spname=SP_SHOW_Tindakan_PV',
                type: 'post',
                data: JSON.stringify(dto1),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    var result = JSON.parse(data);
                    if (result[0].STATUS == "DELETED") {
                        Swal.fire(
                            'Success',
                             'Tindakan berhasil di hapus.',
                            'success'
                        ).then((result) => {
                            if (result.value) {                               
                                GetTindakanPencegahanPV();
                            }
                        });
                    }

                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        });
       
    }

    $(document).ready(function () {
        GetTindakanPencegahanPV();
        DeleteTindakanPencegahanPV();
    });
</script>