r
@{
    ViewBag.Title = "FormCAPA";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    @@media (min-width: 768px) {
        .modal-xl {
            width: 900%;
            max-width: 1300px;
        }
    }
</style>

<link href="~/Content/Scripts/plugins/datatables/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="~/Content/Scripts/plugins/sweetalert2/dist/sweetalert2.min.css" rel="stylesheet" />

<div class="content-body">
    <!--Modal-->
    <div class="modal fade" id="KajianResikoModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Form Kajian Resiko</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-12">
                            <form>
                                <div class="container">
                                    <div class="row form-group col-md-12">
                                        <div class="col-md-6">
                                            <label for="TxtPotensiKegagalan" class="col-form-label">Potensi Kegagalan / Penyimpangan yang mungkin terjadi ketika tindakan perbaikan/pencegahan diterapkan</label>
                                            <div class="input-group">
                                                <textarea type="text" class="form-control" name="TxtPotensiKegagalan" id="TxtPotensiKegagalan"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row form-group col-md-12">
                                        <div class="col-md-6">
                                            <label for="TxtDampak" class="col-form-label">Dampak</label>
                                            <div class="input-group">
                                                <textarea type="text" class="form-control" name="TxtDampak" id="TxtDampak"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="TxtSpesifikasi" class="col-form-label">Spesifikasi / Syarat</label>
                                            <div class="input-group">
                                                <textarea type="text" class="form-control" name="TxtSpesifikasi" id="TxtSpesifikasi"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row form-group col-md-12">
                                        <div class="col-md-6">
                                            <label for="TxtPenyebabPotensial" class="col-form-label">Penyebab Potensial</label>
                                            <div class="input-group">
                                                <textarea type="text" class="form-control" name="TxtPenyebabPotensial" id="TxtPenyebabPotensial"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="TxtMPenyebabPotensial" class="col-form-label">Mengatasi Penyebab Potensial</label>
                                            <div class="input-group">
                                                <textarea type="text" class="form-control" name="TxtMPenyebabPotensial" id="TxtMPenyebabPotensial"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row form-group col-md-12">
                                        <div class="col-md-6">
                                            <label for="TxtMPotensi_KLMD" class="col-form-label">Mencegah Potensi Kegagalan Lolos Menimbulkan Dampak</label>
                                            <div class="input-group">
                                                <textarea type="text" class="form-control" name="TxtMPotensi_KLMD" id="TxtMPotensi_KLMD"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row form-group col-md-12">
                                        <div class="col-md-4">
                                            <label for="Severity_DDL" class="col-form-label">Severity</label>
                                            <div class="input-group">
                                                <select class="form-control select2" id="Severity_DDL" required>
                                                    <option selected disabled value="-">*Pilih*</option>
                                                    <option value="1">1</option>
                                                    <option value="4">4</option>
                                                    <option value="7">7</option>
                                                    <option value="10">10</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="Likelihood_DDL" class="col-form-label">Likelihood</label>
                                            <div class="input-group">
                                                <select class="form-control select2" id="Likelihood_DDL" required>
                                                    <option selected disabled value="-">*Pilih*</option>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="4">4</option>
                                                    <option value="8">8</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="Detectability_DDL" class="col-form-label">Detectability</label>
                                            <div class="input-group">
                                                <select class="form-control select2" id="Detectability_DDL" required>
                                                    <option selected disabled value="-">*Pilih*</option>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row form-group col-md-12">
                                        <div class="form-group col-md-6">
                                            <label for="TxtRPN" class="col-form-label">RPN</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" name="TxtRPN" id="TxtRPN" readonly />
                                            </div>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="TxtRiskLevel" class="col-form-label">Risk Level</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" name="TxtRiskLevel" id="TxtRiskLevel" readonly />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="container" id="Div_KajianResikoModal" hidden>
                                    <div class="form-group col-md-3">
                                        <label for="Target_DDL" class="col-form-label">Target</label>
                                        <div class="input-group">
                                            <select class="form-control select2" id="Target_DDL" required>
                                                <option selected disabled value="">*Pilih*</option>
                                                <option value="Low">Low</option>
                                                <option value="Medium">Medium</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row form-group col-md-12">
                                        <div class="col-md-6">
                                            <label for="TxtMPotensi_K" class="col-form-label">Menghilangkan Potensi Kegagalan/ Penyimpangan</label>
                                            <div class="input-group">
                                                <textarea type="text" class="form-control" name="TxtMPotensi_K" id="TxtMPotensi_K"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="TxtMPenyebab_P" class="col-form-label">Perbaikan untuk mengatasi Penyebab Potensial</label>
                                            <div class="input-group">
                                                <textarea type="text" class="form-control" name="TxtMPenyebab_P" id="TxtMPenyebab_P"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row form-group col-md-12">
                                        <div class="col-md-6">
                                            <label for="TxtDPotensi_K" class="col-form-label">Perbaikan untuk meningkatkan deteksi potensi kegagalan</label>
                                            <div class="input-group">
                                                <textarea type="text" class="form-control" name="TxtDPotensi_K" id="TxtDPotensi_K"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row form-group col-md-12">
                                        <div class="col-md-4">
                                            <label for="Severity2_DDL" class="col-form-label">Severity</label>
                                            <div class="input-group">
                                                <select class="form-control select2" id="Severity2_DDL" required>
                                                    <option selected disabled value="-">*Pilih*</option>
                                                    <option value="1">1</option>
                                                    <option value="4">4</option>
                                                    <option value="7">7</option>
                                                    <option value="10">10</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <label for="Likelihood2_DDL" class="col-form-label">Likelihood</label>
                                            <div class="input-group">
                                                <select class="form-control select2" id="Likelihood2_DDL" required>
                                                    <option selected disabled value="-">*Pilih*</option>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="4">4</option>
                                                    <option value="8">8</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <label for="Detectability2_DDL" class="col-form-label">Detectability</label>
                                            <div class="input-group">
                                                <select class="form-control select2" id="Detectability2_DDL" required>
                                                    <option selected disabled value="-">*Pilih*</option>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row form-group col-md-12">
                                        <div class="col-md-6">
                                            <label for="TxtRPN2" class="col-form-label">RPN</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" name="TxtRPN2" id="TxtRPN2" readonly />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="TxtRiskLevel2" class="col-form-label">Risk Level</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" name="TxtRiskLevel2" id="TxtRiskLevel2" readonly />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="container" id="Div_TxtPIC" hidden>
                                    <div class="row form-group col-md-12">
                                        <div class="col-md-4">
                                            <label for="TxtPIC" class="col-form-label">PIC</label>
                                            <div class="input-group">
                                                <input type="text" id="TxtPICName" name="TxtPICName" class="form-control form-control-sm" readonly>
                                                <input type="text" id="TxtPIC" name="TxtPIC" class="form-control form-control-sm" hidden>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row form-group col-md-12">
                                        <div class="col-md-4">
                                            <label for="TxtLainnya" class="col-form-label">Lainnya</label>
                                            <div class="input-group">
                                                <textarea type="text" class="form-control" name="TxtLainnya" id="TxtLainnya"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="DueDate_Kajian" class="col-form-label">Due Date</label>
                                            <div class="input-group">
                                                <input type="date" id="DueDate_Kajian" class="form-control form-control-sm">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="container">
                                    <div class="form-group col-md-6">
                                        <button type="button" class="btn btn-primary" id="btn_KajianResiko">Tambahkan</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="Modal_Diag" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Fishbone Diagram</h5>
                </div>
                <div class="modal-body">
                    <div id="DiagManusia"
                         style="width:100%; height:300px; background-color: #DAE4E4;"></div>
                    <br />

                    <div id="DiagMaterial"
                         style="width:100%; height:300px; background-color: #DAE4E4;"></div>
                    <br />
                    <div id="DiagLingkungan"
                         style="width:100%; height:300px; background-color: #DAE4E4;"></div>
                    <br />

                    <div id="DiagMesin"
                         style="width:100%; height:300px; background-color: #DAE4E4;"></div>
                    <br />

                    <div id="DiagMetode"
                         style="width:100%; height:300px; background-color: #DAE4E4;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="btn_Close_Diag">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row page-titles mx-0">
        <div class="col p-md-0">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="javascript:void(0)">Dashboard</a></li>
                <li class="breadcrumb-item active"><a href="javascript:void(0)">Form CAPA</a></li>
            </ol>
        </div>
    </div>
    <!-- row -->

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Form CAPA</h4>
                        <form>
                            <div class="row">
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-20">Tanggal</label>
                                    <input type="text" id="date-format" class="form-control form-control-sm" value="@DateTime.Today.ToShortDateString()" readonly>
                                </div>
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-40">PIC CAPA</label>
                                    <input class="form-control form-control-sm" type="text" id="input_Requestor" value="@Request.RequestContext.HttpContext.Session["FullName"]" readonly>
                                    @*<input class="form-control form-control-sm" type="text" id="input_Requestor_NIK" value="HARDCODE_NIK" hidden>*@
                                    <input class="form-control form-control-sm" type="text" id="input_Requestor_NIK" value="@Request.RequestContext.HttpContext.Session["NIK"]" hidden>
                                </div>
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-20">Nomor CAPA</label>
                                    <input class="form-control form-control-sm" type="text" id="input_NoCAPA" value="@Request.QueryString["NoCAPA"]" readonly>

                                </div>
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-40">Departemen</label>
                                    <input class="form-control form-control-sm" type="text" id="input_Departemen" value="@Request.RequestContext.HttpContext.Session["Departemen"]" readonly>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Request Page</h4>
                        <button class="btn btn-dark form-control col-sm-2" id="btn_Request">Request</button>
                    </div>
                </div>

                <div class="card" id="Div_RejectReason">
                    <div class="card-body">
                        <div class="form-group mb-2 col-sm-4">
                            <h4 class="card-title">Reject Reason</h4>
                            <textarea class="m-t-20 form-control " id="TxtRejectReason" readonly></textarea>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Analisa Kondisi</h4>
                        <div class="table-responsive" id="Div_AnalisaKondisiInput">
                            <table class="table table-hover table-bordered zero-configuration" style="color:black">
                                <thead>
                                    <tr>
                                        <th>Aspect</th>
                                        <th>WHAT SHOULD BE HAPPENED</th>
                                        <th>WHAT ACTUALLY HAPPENED</th>
                                        <th style="text-align: center">OK/NOK</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <select class="form-control form-control-sm" id="Select_AspectKondisi">
                                                <option>Manusia</option>
                                                <option>Material/Produk</option>
                                                <option>Metode</option>
                                                <option>Mesin</option>
                                                <option>Lingkungan</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;" id="TxtWSBH"></td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;" id="TxtWAH"></td>
                                        <td>
                                            @*<input type="text" class="form-control form-control-sm" style="width:100%;" id="TxtStatus">*@
                                            <div class="radio" style="text-align: center">
                                                <label class="radio-inline mr-3">
                                                    <input type="radio" name="optradio" value="OK"> OK
                                                </label>
                                                <label class="radio-inline mr-3">
                                                    <input type="radio" name="optradio" value="NOT OK"> NOT OK
                                                </label>
                                            </div>
                                        </td>
                                        <th><button class="form-control-sm" id="btn_AddKondisi">Add</button></th>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered zero-configuration" id="Tbl_Kondisi" style="color: black">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Aspect</th>
                                        <th>WHAT SHOULD BE HAPPENED</th>
                                        <th>WHAT ACTUALLY HAPPENED</th>
                                        <th style="text-align: center">OK/NOK</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="Tbl_Analisa">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card" id="Div_PRCA">
                    <div class="card-body">
                        <h4 class="card-title">Potential Root Cause Analysis</h4>
                        @*<div class="table-responsive">
                                <!--<table class="table table-striped table-bordered zero-configuration">
                                    <thead>
                                        <tr>
                                            <th>Aspect</th>
                                            <th>WHAT ACTUALLY HAPPENED</th>
                                            <th>WHY</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="Tbl_PRCA">
                                        <tr>-->
                                            @*<td>Manusia</td>
                            <td><input type="text" class="form-control form-control-sm" style="width:100%;" readonly></td>
                            <td><input type="text" class="form-control form-control-sm" style="width:100%;"></td>
                            <th><button class="form-control-sm">Add</button></th>
                                        <!--</tr>
                                    </tbody>
                                </table>
                            </div>-->*@
                        <form>
                            <div class="row form-group-sm mb-2">
                                <div class="col-md-6">
                                    <label class="m-t-20">Aspect<span style="color: red">*</span></label>
                                    <select class="form-control form-control-sm" id="Aspect_DDL" name="Aspect" required>
                                    </select>
                                </div>
                            </div>
                            <div class="row form-group-sm mb-3">
                                <div class="col-md-6">
                                    <label class="m-t-20">What Actually Happened<span style="color: red">*</span></label>
                                    <select class="form-control form-control-sm" id="WAH_DDL" name="WAH" required>
                                    </select>
                                </div>
                            </div>
                            <div class="row form-group-sm mb-2">
                                <div class="col-md-6">
                                    <label class="m-t-20">Parent?<span style="color: red; visibility: hidden">**</span></label>
                                    <input class="checkbox" type="checkbox" value="Yes" id="isParent" />
                                </div>
                            </div>
                            <div class="row form-group-sm mb-2" id="Div_WhyParent">
                                <div class="col-md-6">
                                    <label class="m-t-20">Why Parent<span style="color: red">*</span></label>
                                    <select class="form-control form-control-sm" id="WhyParent_DDL" name="WhyParent_DDL">
                                    </select>
                                </div>
                            </div>
                            <div class="row form-group-sm mb-2">
                                <div class="col-md-6">
                                    <label class="m-t-20">Why<span style="color: red">*</span></label>
                                    <input class="form-control" type="text" id="TxtWhy" />
                                </div>
                            </div>
                            <div class="row form-group-sm mb-2">
                                <div class="col-md-6">
                                    <button class="form-control-sm" type="button" id="btn_AddWhy">Add</button>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Potential Root Cause </h4>
                        <input type="button" class="btn btn-primary" id="ShowDiag" data-toggle="modal" data-target="#Modal_Diag" data-backdrop="static" value="Show Diagram" />
                    </div>
                </div>

                <div class="card" id="Div_TindakanPerbaikan">
                    <div class="card-body">
                        <h4 class="card-title">Penentuan Tindakan Perbaikan</h4>
                        <div>
                            <form>
                                <div class="row form-group-sm">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Root Cause</label>
                                        <select id="RootCause_DDL" class="form-control">
                                        </select>
                                    </div>
                                </div>
                                <div class="row form-group-sm">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Tindakan Perbaikan<span style="color: red">*</span></label>
                                        <textarea type="text" class="form-control" placeholder="Deskripsi" id="TxtDeskripsiPerbaikan"></textarea>
                                    </div>
                                    <div class="form-group mb-2 col-sm-3">
                                        <label class="m-t-20">Due Date</label>
                                        <input type="date" id="duedate_perbaikan" class="form-control form-control-sm">
                                    </div>
                                </div>
                                <div class="row form-group">
                                    <div class="col-md-4">
                                        <label for="DepartemenPerbaikan_DDL" class="col-form-label">Departemen</label>
                                        <div class="input-group">
                                            <select class="form-control" name="DepartemenPerbaikan_DDL" id="DepartemenPerbaikan_DDL">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="Div_VendorNamePerbaikan" hidden>
                                        <label for="VendorPerbaikan_DDL" class="col-form-label">Vendor</label>
                                        <div class="input-group">
                                            <select class="form-control" name="VendorPerbaikan_DDL" id="VendorPerbaikan_DDL">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row form-group">
                                    <div class="col-md-3">
                                        <label class="m-t-40">Nama Personil</label>
                                        <div class="input-group mb-3">
                                            <select class="form-control" name="NamaPersonilPerbaikan_DDL" id="NamaPersonilPerbaikan_DDL">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="m-t-40">Alamat Email</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="TxtEmailPerbaikan" readonly>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <label class="m-t-40">Apakah ada proses / area lain yang berpotensi sama ?</label>
                                        <div class="radio input-group">
                                            <div class="col-sm-3">
                                                <label><input type="radio" value="Yes" name="Potensi">Ya</label>
                                            </div>
                                            <div class="col-sm-3">
                                                <label><input type="radio" value="No" name="Potensi">Tidak</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-12 mb-3">
                                        <label class="m-t-40" style="visibility: hidden">_</label>
                                        <div class="input-group">
                                            <button type="button" id="btn_AddPerbaikan" class="btn mb-1 btn-primary ">Tambahkan Tindakan Perbaikan</button>
                                        </div>
                                    </div>

                                </div>
                            </form>
                        </div>
                        <div id="TblTindakanPerbaikan">
                            @Html.Partial("TindakanPerbaikanPV")
                        </div>
                    </div>
                </div>

                <div class="card" id="Div_TindakanPencegahan">
                    <div class="card-body">
                        <h4 class="card-title">Penentuan Tindakan Pencegahan </h4>
                        <div>
                            <form>
                                <div class="row form-group-sm">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Tindakan Perbaikan</label>
                                        <select id="AreaLain_DDL" class="form-control">
                                        </select>
                                    </div>
                                </div>
                                <div class="row form-group-sm">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Area / Proses lain yang Berpotensi</label>
                                        <textarea id="TxtAreaLainPencegahan" class="form-control" placeholder="Area lain yang berpotensi"></textarea>
                                    </div>
                                </div>
                                <div class="row form-group-sm">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Tindakan Pencegahan<span style="color: red">*</span></label>
                                        <textarea type="text" class="form-control" id="TxtDeskripsiPencegahan" placeholder="Deskripsi"></textarea>
                                    </div>
                                    <div class="form-group mb-2 col-sm-3">
                                        <label class="m-t-20">Due Date</label>
                                        <input type="date" id="duedate_pencegahan" class="form-control form-control-sm">
                                    </div>
                                </div>
                                <div class="row form-group">
                                    <div class="col-md-4">
                                        <label for="DepartemenPencegahan_DDL" class="col-form-label">Departemen</label>
                                        <div class="input-group">
                                            <select class="form-control" name="DepartemenPencegahan_DDL" id="DepartemenPencegahan_DDL">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="Div_VendorNamePencegahan" hidden>
                                        <label for="VendorPencegahan_DDL" class="col-form-label">Vendor</label>
                                        <div class="input-group">
                                            <select class="form-control" name="VendorPencegahan_DDL" id="VendorPencegahan_DDL">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row form-group">
                                    <div class="col-md-3">
                                        <label class="m-t-40">Nama Personil</label>
                                        <div class="input-group mb-3">
                                            <select class="form-control" name="NamaPersonilPencegahan_DDL" id="NamaPersonilPencegahan_DDL">
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="m-t-40">Alamat Email</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="TxtEmailPencegahan" readonly>
                                        </div>
                                    </div>

                                    <div class="col-md-12 mb-3">
                                        <label class="m-t-40" style="visibility: hidden">_</label>
                                        <div class="input-group">
                                            <button type="button" id="btn_AddPencegahan" class="btn mb-1 btn-primary ">Tambahkan Tindakan Pencegahan</button>
                                        </div>
                                    </div>

                                </div>
                            </form>
                        </div>
                        <div id="TblTindakanPencegahan">
                            @Html.Partial("TindakanPencegahanPV")
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Kajian Resiko</h4>
                        <div class="row form-group" id="Div_KajianResiko_DDL">
                            <div class="col-md-7">
                                <select id="RootCause_KajianResikoDDL" class="form-control">
                                </select>
                                <input value="" id="TxtRecordID" hidden /> <!--Line Number Kajian Resiko-->
                                <input value="" id="TxtTipe" hidden /> <!--Tipe Kajian Resiko-->
                            </div>
                            <div class="col-md-3">
                                <button type="button" id="btn_AddKajian" class="btn btn-dark mb-2" data-toggle="modal" data-target="#KajianResikoModal">Tambahkan Kajian Resiko</button>
                            </div>
                        </div>
                        <div class="table-responsive mb-3">
                            <table class="table table-hover table-bordered zero-configuration" id="Tbl_KajianResiko" style="color:black">
                                <thead>
                                    <tr>
                                        <th style="display: none;">NoCAPA</th>
                                        <th style="display: none;">LineNumber</th>
                                        <th>Tindakan</th>
                                        <th>Potensi Kegagalan / Penyimpangan yang mungkin terjadi ketika tindakan perbaikan/pencegahan diterapkan</th>
                                        <th>Spesifikasi / Syarat</th>
                                        <th>Dampak</th>
                                        <th>Severity (S)</th>
                                        <th>Penyebab Potensial</th>
                                        <th>Mengatasi Penyebab Potensial</th>
                                        <th>Likelihood (L)</th>
                                        <th>Mencegah Potensi Kegagalan Lolos Menimbulkan Dampak</th>
                                        <th>Detectability (D) </th>
                                        <th>RPN (SxLxD)</th>
                                        <th>Risk Level</th>
                                        <th>TARGET</th>
                                        <th>Menghilangkan Potensi Kegagalan/ Penyimpangan</th>
                                        <th>Severity (S)</th>
                                        <th>PERBAIKAN untuk mengatasi Penyebab Potensial</th>
                                        <th>Likelihood (L)</th>
                                        <th>PERBAIKAN untuk meningkatkan deteksi potensi kegagalan</th>
                                        <th>Detectability (D)</th>
                                        <th>RPN (SxLxD)</th>
                                        <th>Risk Level</th>
                                        <th>PIC</th>
                                        <th>Due Date</th>
                                        <th>Lainnya</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="Tbl_PRCA">
                                    @*<tr>
                                        <td>Tindakan</td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;"></td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;"></td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;"></td>
                                        <td>
                                            <select id="SaverityDDL" class="form-control">
                                                <option value="1">1</option>
                                                <option value="4">4</option>
                                                <option value="7">7</option>
                                                <option value="10">10</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;"></td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;"></td>
                                        <td>
                                            <select id="LikelihoodDDL" class="form-control">
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="4">4</option>
                                                <option value="8">8</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;"></td>
                                        <td>
                                            <select id="DetectabilityDDL" class="form-control">
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                                <option value="4">4</option>
                                            </select>
                                        </td>
                                        <td>SxLxD</td>
                                        <td>Level Risk Color</td>
                                        <td>
                                            <select id="DetectabilityDDL" class="form-control">
                                                <option value="Low">Low</option>
                                                <option value="Medium">Medium</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;"></td>
                                        <td>
                                            <select id="LikelihoodDDL" class="form-control">
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="4">4</option>
                                                <option value="8">8</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;"></td>
                                        <td>
                                            <select id="DetectabilityDDL" class="form-control">
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                                <option value="4">4</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="form-control form-control-sm" style="width:100%;"></td>
                                        <td>
                                            <select id="DetectabilityDDL" class="form-control">
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                                <option value="4">4</option>
                                            </select>
                                        </td>
                                        <td>SxLxD</td>
                                        <td>Level Risk Color</td>
                                        <td>PIC</td>
                                        <td>Due Date</td>
                                        <td>Lainnya</td>
                                        <td><button class="form-control-sm">Delete</button></td>
                                    </tr>*@
                                </tbody>
                            </table>
                        </div>
                        <div class="row form-group" style="float: left">
                            <div class="col-md-3">
                                <button type="button" id="btn_Submit" class="btn btn-primary mb-2">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- #/ container -->
    </div>
</div>

@*JQuery Library*@
@*<script src="../plugins/bootstrap-material-datetimepicker/js/bootstrap-material-datetimepicker.js"></script>
    <script src="../plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>*@
<script src="~/Content/Scripts/plugins/sweetalert2/dist/sweetalert2.min.js" defer></script>
<script src="~/Content/Scripts/plugins/datatables/jquery.dataTables.min.js" defer></script>
<script src="~/Content/Scripts/plugins/jquery/jquery.min.js"></script>
<script src="https://unpkg.com/gojs/release/go-debug.js" defer></script>

<script>
    var rootcauses;
    var area_lains;
    var myDiagram;
    //Check Jika status 1 maka button submit disabled.
    function checkStatusCAPA() {
        $.ajax({
            url: 'CheckStatusCAPA',
            type: 'post',
            data: JSON.stringify({
                Model: {
                    NO_CAPA: $('#input_NoCAPA').val(),
                    Option: 14,
                    Aspect: '',
                    WSBH: '',
                    WAH: '',
                    Status: '',
                    isParent: '',
                    WHY_Parent: '',
                    WHY: '',
                    Tindakan: '',
                    Pelaksana: '',
                    LineNumber: '',
                    NamaPersonil: '',
                    Email: '',
                    DueDate: '',
                    Is_AreaLain: '',
                    WhyID: '',
                    WhyParentID: '',
                    RootCause: '',
                    Create_By: '',
                    RecordID: ''
                }
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {            
                var result = JSON.parse(data)[0];
               
                var hide = (result.STATUS_ID == 1) ? (false) : (true); // jika status CAPA = 1 maka, hide = false , sebaliknya.
                btnDelete = hide; //btn Delete di dalam Table KajianResiko dan AnalisaKondisi switch on/off berdasarkan variable hide.
               

                $('#btn_Submit').prop('hidden', hide);
                $('#Div_AnalisaKondisiInput').prop('hidden', hide);
                $('#Div_PRCA').prop('hidden', hide);
                $('#Div_KajianResiko_DDL').prop('hidden', hide);
                $('#TxtRejectReason').text(result.REJECT_REASON);
                if (result.REJECT_REASON == '-') {
                    $('#Div_RejectReason').prop('hidden', true);
                }
                
                $('#Div_TindakanPerbaikan').prop('hidden', hide);
                $('#Div_TindakanPencegahan').prop('hidden', hide);
                //$('#TblTindakanPencegahan').prop('hidden', hide);
                //$('#TblTindakanPerbaikan').prop('hidden', hide);

                if (!hide) {
                    retrieveData();
                    retrieveData2();
                }
                getTable(!hide);
                TableKajian(!hide);
                //isHide = true;
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function populatePotentialRootCauseDDL(data) {
        $('#Aspect_DDL').append(new Option("*Pilih*", "-"));
        $.each(data, function (key, value) {
            if (Object.keys(value)[2] == "WAHType" && value.WAHStatus == "NOT OK") {
                if ($("#Aspect_DDL option:contains(" + value.WAHType + ")").val() != value.WAHType) {
                    $('#Aspect_DDL').append(new Option(value.WAHType, value.WAHType));
                }
            }
            //if (Object.keys(value)[4] == "WAHDesc")
            //    $('#WAH_DDL').append(new Option(value.WAHDesc, vHtmllue.WAHDesc));
        });

        $('#Aspect_DDL').change(function () {
            $('#WhyParent_DDL').empty();
            getWAH(data);
        });
    }

    function getWAH(data) {
        $('#WAH_DDL').empty();
        $('#WAH_DDL').append(new Option("*Pilih*", "-"));
        var aspect = $('#Aspect_DDL').val();
        $.each(data, function (key, value) {
            if (Object.keys(value)[2] == "WAHType" && value.WAHStatus == "NOT OK") {
                if (aspect == value.WAHType) {
                    $('#WAH_DDL').append(new Option(value.WAHDesc, value.WAHDesc));
                }
            }
        });

        $('#WAH_DDL').change(function () {
            getWhyParent();
        });
    }

    function TableKajian(hide) {
        $.ajax({
            url: 'GetKajianResiko',
            type: 'post',
            data: JSON.stringify({
                Model: {
                    NO_CAPA: $('#input_NoCAPA').val(),
                    Option: 11,
                    Aspect: '',
                    WSBH: '',
                    WAH: '',
                    Status: '',
                    isParent: '',
                    WHY_Parent: '',
                    WHY: '',
                    Tindakan: '',
                    Pelaksana: '',
                    LineNumber: '',
                    NamaPersonil: '',
                    Email: '',
                    DueDate: '',
                    Is_AreaLain: '',
                    WhyID: '',
                    WhyParentID: '',
                    RootCause: '',
                    Create_By: '',
                    RecordID: ''
                }
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#Tbl_KajianResiko').DataTable({
                    "pageLength": 5,
                    "lengthChange": true,
                    "searching": false,
                    "paging": false,
                    "info": false,
                    "data": JSON.parse(data),
                    "select": true,
                    "bDestroy": true,
                    "scrollCollapse": true,
                    "columns": [
                        { "data": "NoCAPA_FK" },
                        { "data": "LineNumber" },
                        { "data": "Tindakan" },
                        { "data": "P_Kegagalan" },
                        { "data": "Spek" },
                        { "data": "Dampak" },
                        { "data": "Severity" },
                        { "data": "Penyebab" },
                        { "data": "M_Penyebab" },
                        { "data": "Likelihood" },
                        { "data": "M_PKegagalan_LMD" },
                        { "data": "Detectability" },
                        { "data": "RPN" },
                        {
                            "data": "RiskLevel",
                            "className": "riskLevel"
                        },
                        { "data": "Target" },
                        { "data": "M_PKegagalan" },
                        { "data": "Severity2" },
                        { "data": "P_MPenyebab" },
                        { "data": "Likelihood2" },
                        { "data": "P_MDPKegagalan" },
                        { "data": "Detectability2" },
                        { "data": "RPN2" },
                        {
                            "data": "RiskLevel2",
                            "className": "riskLevel2"
                        },
                        { "data": "FullName" },
                        { "data": "DueDate" },
                        { "data": "Lainnya" },
                        {
                            "data": null,
                            "defaultContent": "<button class='btn btn-danger delete' type='button' name='delete' onchange=''>Delete</button> "
                        },
                    ],
                    "columnDefs": [
                        {
                            "targets": 0,
                            "visible": false
                        },
                        {
                            "targets": 1,
                            "visible": false
                        },
                        {
                            "targets": 26,
                            "visible": hide
                        }


                    ],
                    "order": [[1, 'asc']],
                    "rowCallback": function (row, data) {
                        ColoredColumns(row, data.RiskLevel, "riskLevel");
                        ColoredColumns(row, data.RiskLevel2, "riskLevel2");
                    }
                });
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function ColoredColumns(row, d, className) {
        if (d == "Low") {
            $('td.' + className, row).css({
                background: "limegreen",
                color: "black"
            });
        } else if (d == "Medium") {
            $('td.' + className, row).css({
                background: "yellow",
                color: "black"
            });
        } else if (d == "High") {
            $('td.' + className, row).css({
                background: "red",
                color: "white"
            });
        } else if (d == "Very High") {
            $('td.' + className, row).css({
                background: "black",
                color: "white"
            });
        }
    }

    function getTable(hide) {
        //Jquery untuk panggil datasource datatable
        $('#Aspect_DDL').empty();
        $('#WAH_DDL').empty();
        $('#Tbl_Analisa').empty();

        $.ajax({
            url: 'GetDataPIC',
            type: 'post',
            data: JSON.stringify({
                Option: 2,
                NO_CAPA: $('#input_NoCAPA').val(),
                SP: "[dbo].[SP_FORM_CAPA]"
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var t = $('#Tbl_Kondisi').DataTable({
                    "pageLength": 10,
                    "responsive": true,
                    "info": false,
                    "paging": false,
                    "lengthChange": true,
                    "searching": false,
                    "data": JSON.parse(data),
                    "select": true,
                    "bDestroy": true,
                    "scrollCollapse": true,
                    "columns": [
                        { "data": null },
                        { "data": "WAHType" },
                        { "data": "WSBHDesc" },
                        { "data": "WAHDesc" },
                        { "data": "WAHStatus" },
                        {
                            "data": null,
                            "defaultContent": "<span><a class='delete' href='' onclick='return false;' data-toggle='tooltip' data-placement='top' title='Close'><i class='fa fa-close color-danger'></i></a></span>"
                        }
                    ],
                    "order": [[1, 'asc']],
                    "columnDefs": [
                        {
                            "targets": 5,
                            "className": "text-center",
                            "visible": hide
                        }
                    ]
                });
                //Indexing Number of Rows
                t.on('order.dt search.dt', function () {
                    t.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                        cell.innerHTML = i + 1;
                    });
                }).draw();

                populatePotentialRootCauseDDL(JSON.parse(data)); // Fill Potential Root Cause Options Dropdownlist


            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function retrieveData() {
        $.ajax({
            url: 'GetDataPIC',
            type: 'post',
            data: JSON.stringify({
                Option: 6,
                NO_CAPA: $('#input_NoCAPA').val(),
                SP: "[dbo].[SP_FORM_CAPA]"
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (rootcause) {
                var countAdd = 0;
                $('#RootCause_DDL').empty();
                $('#RootCause_DDL').append(new Option("*Pilih*", ""));
                $.each(JSON.parse(rootcause), function (key, value) {
                    $('#RootCause_DDL').append(new Option(value.WhyDesc, value.WhyDesc));
                });
                rootcauses = JSON.parse(rootcause);                
                //$('#btn_AddPerbaikan').click(function () {
                //    countAdd++;
                //    if (countAdd > 1) {
                //        return;
                //    }
                //    else {
                //        var dto = {};
                //        var kategori = "Perbaikan";
                //        var obj = JSON.parse(rootcause);

                //        $.each(obj, function (key, value) {
                //            if (value.WhyDesc == $('#RootCause_DDL').val()) {
                //                dto = {
                //                    Option: 7,
                //                    NO_CAPA: $('#input_NoCAPA').val(),
                //                    Aspect: value.Aspect,
                //                    WhyID: value.WhyID,
                //                    WhyParentID: value.ParentID,
                //                    RootCause: value.WhyDesc,
                //                    Tindakan: $('#TxtDeskripsiPerbaikan').val(),
                //                    Pelaksana: $('#NamaPersonilPerbaikan_DDL').val(),
                //                    Departemen: $('#DepartemenPerbaikan_DDL').val(),
                //                    LineNumber: value.LineNumber,
                //                    DueDate: $('#duedate_perbaikan').val(),
                //                    NamaPersonil: $('#NamaPersonilPerbaikan_DDL option:selected').text(),
                //                    Email: $('#TxtEmailPerbaikan').val(),
                //                    Is_AreaLain: $('input[name="Potensi"]:checked').val(),
                //                    Create_By: $('#input_Requestor_NIK').val(),
                //                    Status: "Active",
                //                    Status_ID: 1,
                //                    SP: "[dbo].[SP_FORM_CAPA]"
                //                }
                //                return false;
                //            }
                //        });

                //        addTindakan(dto, kategori);
                //    }
                //});
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function retrieveData2() {
        $.ajax({
            url: 'GetDataPIC',
            type: 'post',
            data: JSON.stringify({
                Option: 8,
                NO_CAPA: $('#input_NoCAPA').val(),
                SP: "[dbo].[SP_FORM_CAPA]"
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (area_lain) {
                var countAdd = 0;
                var data = JSON.parse(area_lain);
                if (data.length == 0) {
                    $('#Div_TindakanPencegahan').prop('hidden', true);
                } else {
                    $('#Div_TindakanPencegahan').prop('hidden', false);
                    $('#AreaLain_DDL').empty();
                    $('#AreaLain_DDL').append(new Option("*Pilih*", ""));
                    $.each(JSON.parse(area_lain), function (key, value) {
                        $('#AreaLain_DDL').append(new Option(value.Tindakan_Perbaikan, value.Tindakan_Perbaikan));
                    });
                    area_lains = JSON.parse(area_lain);      
                    //$('#btn_AddPencegahan').click(function () {
                    //    countAdd++;
                    //    if (countAdd > 1) {
                    //        return false;
                    //    } else {
                    //        //console.log()
                    //        var dto = {};
                    //        var kategori = "Pencegahan";
                    //        var obj = JSON.parse(area_lain);
                    //        $.each(obj, function (key, value) {
                    //            if (value.Tindakan_Perbaikan == $('#AreaLain_DDL').val()) {
                    //                dto = {
                    //                    Option: 9,
                    //                    NO_CAPA: $('#input_NoCAPA').val(),
                    //                    Aspect: value.WAHType_FK,
                    //                    WhyID: value.WhyID,
                    //                    WhyParentID: value.WhyParentID,
                    //                    RootCause: value.Tindakan_Perbaikan,
                    //                    AreaLain: $('#TxtAreaLainPencegahan').val(),
                    //                    Tindakan: $('#TxtDeskripsiPencegahan').val(),
                    //                    Pelaksana: $('#NamaPersonilPencegahan_DDL').val(),
                    //                    Departemen: $('#DepartemenPencegahan_DDL').val(),
                    //                    LineNumber: value.LineNumber,
                    //                    DueDate: $('#duedate_pencegahan').val(),
                    //                    NamaPersonil: $('#NamaPersonilPencegahan_DDL option:selected').text(),
                    //                    Email: $('#TxtEmailPencegahan').val(),
                    //                    Create_By: $('#input_Requestor_NIK').val(),
                    //                    Status: "Active",
                    //                    Status_ID: 1,
                    //                    SP: "[dbo].[SP_FORM_CAPA]"
                    //                }
                    //                return false;
                    //            }
                    //        });
                    //        addTindakan(dto, kategori);
                    //    }
                    //});
                }
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function addTindakan(dto, kategori) {
        var valid = false;
        $.each(dto, function (key, value) {
            if (value == '' || value == '-' || value == null) {
                if (value == 0 || typeof value === "undefined")
                    valid = true;
                else
                    return valid = false;
            } else {
                valid = true;
            }
        });

        if (valid) {
            $.ajax({
                url: 'AddTindakan',
                type: 'post',
                data: JSON.stringify(dto),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',

                success: function (data) {
                    var status = JSON.parse(data);
                    if (status[0].Status_Inserted != 'Tindakan Perbaikan' || status[0].Status_Inserted != 'Tindakan Pencegahan') {
                        Swal.fire(
                            'Success',
                            status[0].Status_Inserted + ' berhasil di-input.',
                            'success'
                        ).then((result) => {
                            if (result.value) {
                                if (status[0].Status_Inserted == 'Tindakan Pencegahan') {
                                    retrieveData();
                                } else {
                                     retrieveData2();
                                }                                                               
                                KajianResikoDDL();
                                RemoveInputField(kategori);
                                GetTindakanPencegahanPV();
                                GetTindakanPerbaikanPV();
                            }
                        });
                    }
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        } else {
            Swal.fire(
                'Maaf',
                'Input tidak boleh kosong.',
                'warning'
            )
        }
    }

    function KajianResikoDDL() {
        $.ajax({
            url: 'GetDataPIC',
            type: 'post',
            data: JSON.stringify({
                Option: 10,
                NO_CAPA: $('#input_NoCAPA').val(),
                SP: "[dbo].[SP_FORM_CAPA]"
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                getDataTindakan(JSON.parse(data));
                $('#RootCause_KajianResikoDDL').empty();
                $.each(JSON.parse(data), function (key, value) {
                    $('#RootCause_KajianResikoDDL').append(new Option(value.Tindakan, value.Tindakan));
                });
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    var objTindakan;
    function getDataTindakan(data) {
        return objTindakan = data;
    }// refer to KajianResikoDDL();

    //search Tindakan get record_id and Tipe
    var values; //objTindakan filtered.
    function recTindakan(increments) {
        if (objTindakan[increments].Tindakan == $('#RootCause_KajianResikoDDL').val())
            return values = objTindakan[increments];
        else {
            increments++;
            recTindakan(increments);
        }
    } // refer to getDataTindakan();

    function realtimeCalculation() {
        var RPN = 0;
        var RPN2 = 0;
        var Severity = $('#Severity_DDL').val();
        var Detectability = $('#Detectability_DDL').val();
        var Likelihood = $('#Likelihood_DDL').val();
        var Severity2 = $('#Severity2_DDL').val();
        var Detectability2 = $('#Detectability2_DDL').val();
        var Likelihood2 = $('#Likelihood2_DDL').val();

        if (!isNaN(Severity) && !isNaN(Detectability) && !isNaN(Likelihood)) {
            RPN = Severity * Likelihood * Detectability;
            $('#TxtRiskLevel').val(riskCalculation(RPN));
        }

        if (!isNaN(Severity2) && !isNaN(Detectability2) && !isNaN(Likelihood2)) {
            RPN2 = Severity2 * Likelihood2 * Detectability2;
            $('#TxtRiskLevel2').val(riskCalculation(RPN2));
        }


        $('#TxtRPN').val(RPN);
        $('#TxtRPN2').val(RPN2);
    }

    function riskCalculation(RPN) {
        if (RPN > 0 && RPN <= 35)
            return "Low";
        else if (RPN > 35 && RPN <= 80)
            return "Medium";
        else if (RPN > 80 && RPN <= 140)
            return "High";
        else if (RPN >= 140)
            return "Very High";
    }

    function DeleteKajianResiko() {
        $(document).on("click", "#Tbl_KajianResiko button.delete", function () {
            var rows = $(this).closest('tr');
            var data = $('#Tbl_KajianResiko').DataTable().row(rows).data();
            data.Option = 13;
            //console.log(data);
            //console.log({
            //    Model: {
            //        Option: data.Option,
            //        NO_CAPA: data.NoCAPA_FK,
            //        LineNumber: data.LineNumber,
            //        RecordID: data.RecordID
            //    }
            //});

            $.ajax({
                url: 'DeleteKajianResiko',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify({
                    Option: data.Option,
                    NO_CAPA: data.NoCAPA_FK,
                    LineNumber: data.LineNumber,
                    RecordID: data.RecordID
                }),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    TableKajian();
                    return true;
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        });
    }

    function UnhideKajianResikoModal() {
        if ($('#Severity_DDL').val() == 10 || $('#TxtRiskLevel').val() == 'Very High' || $('#TxtRiskLevel').val() == 'High') {
            $('#Div_KajianResikoModal').prop('hidden', false);
            $('#Div_TxtPIC').prop('hidden', false);
        } else {
            $('#Div_KajianResikoModal').prop('hidden', true);
            $('#Div_TxtPIC').prop('hidden', true);
        }
    }

    function getDDLDeptKajianResiko() {
        $.ajax({
            url: 'GetDepartemenKajianResiko',
            type: 'post',
            data: JSON.stringify({
                Model: {
                    Option: 14,
                    NO_CAPA: $('#input_NoCAPA').val()
                }
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                console.log(data);
                $('#DepartemenPerbaikan_DDL').empty();
                $('#DepartemenPencegahan_DDL').empty();
                $('#DepartemenPerbaikan_DDL').append(new Option('*Pilih*', '-'));
                $('#DepartemenPencegahan_DDL').append(new Option('*Pilih*', '-'));
                $.each(JSON.parse(data), function (key, value) {
                    $('#DepartemenPerbaikan_DDL').append(new Option(value.DEPARTEMEN, value.DEPARTEMEN));
                    $('#DepartemenPencegahan_DDL').append(new Option(value.DEPARTEMEN, value.DEPARTEMEN));
                });
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function getVendorDDL() {
        $.ajax({
            url: 'GetVendorList',
            type: 'post',
            data: JSON.stringify({
                Model: {
                    Option: 16
                }
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#VendorPerbaikan_DDL').empty();
                $('#VendorPencegahan_DDL').empty();
                $.each(JSON.parse(data), function (key, value) {
                    $('#VendorPerbaikan_DDL').append(new Option(value.vendor_name, value.vendor_id));
                    $('#VendorPencegahan_DDL').append(new Option(value.vendor_name, value.vendor_id));
                });
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function getPICKajianResiko(kategori) {
        $('#TxtEmail' + kategori).val("");
        var vendor = $('#Vendor' + kategori + '_DDL').val();
        $.ajax({
            url: 'GetPICKajianResiko',
            type: 'post',
            data: JSON.stringify({
                Model: {
                    Option: 17,
                    Departemen: $('#Departemen' + kategori + '_DDL').val(),
                    VendorID: vendor,
                    NO_CAPA: $('#input_NoCAPA').val()
                }
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                console.log(data);
                $('#NamaPersonil' + kategori + '_DDL').empty();
                $('#NamaPersonil' + kategori + '_DDL').append(new Option("*Pilih*", '-'));
                $.each(JSON.parse(data), function (key, value) {
                    $('#NamaPersonil' + kategori + '_DDL').append(new Option(value.EmpName, value.EmpID));
                });

                $('#NamaPersonil' + kategori + '_DDL').change(function () {
                    $.each(JSON.parse(data), function (key, value) {
                        if ($('#NamaPersonil' + kategori + '_DDL').val() == value.EmpID) {
                            if (value.Email_1 == null)
                                $('#TxtEmail' + kategori).val(value.Email_2);
                            else
                                $('#TxtEmail' + kategori).val(value.Email_1);
                            return false;
                        }
                    });
                });
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function getWhyParent() {
        $.ajax({
            url: 'GetDataPIC',
            type: 'post',
            data: JSON.stringify({
                Option: 4,
                NO_CAPA: $('#input_NoCAPA').val(),
                WAH: $('#WAH_DDL').val(),
                Aspect: $('#Aspect_DDL').val(),
                SP: "[dbo].[SP_FORM_CAPA]"
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#WhyParent_DDL').empty();
                $.each(JSON.parse(data), function (key, value) {
                    $('#WhyParent_DDL').append(new Option(value.WhyDescription, value.WhyDescription));
                });
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function GetRootManusia() {
        $.ajax({
            type: "POST",
            url: "../Koordinator/GetRoot?NoCapa=" + $('#input_NoCAPA').val() + "&Type=Manusia",
            dataType: 'json',
            async: true,
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var result = JSON.parse(data);
                //myDiagram.model = new go.TreeModel();
                var $ = go.GraphObject.make;
                myDiagram =
                    $(go.Diagram, "DiagManusia",
                        {
                            "undoManager.isEnabled": true,
                            contentAlignment: go.Spot.Center,
                            layout: $(go.TreeLayout, // specify a Diagram.layout that arranges trees
                                { angle: 90, layerSpacing: 35 })
                        });

                myDiagram.nodeTemplate =
                    $(go.Node, "Horizontal",
                        { background: "#44CCFF", locationSpot: go.Spot.Center },
                        $(go.TextBlock, "Default Text",
                            {
                                margin: 10, width: 75, height: 25, stroke: "white", font: "bold 16px sans-serif", textAlign: "center", wrap: go.TextBlock.WrapFit,
                                verticalAlignment: go.Spot.Center
                            },
                            new go.Binding("text", "type")),
                        $(go.TextBlock, "Default Text",
                            {
                                margin: 10, stroke: "white", font: "bold 16px sans-serif", textAlign: "center", wrap: go.TextBlock.WrapFit,
                                verticalAlignment: go.Spot.Center
                            },
                            new go.Binding("text", "desc"))
                    );


                myDiagram.model = new go.TreeModel(result);
            }
        });
    }

    function GetRootMaterial() {
        $.ajax({
            type: "POST",
            url: "../Koordinator/GetRoot?NoCapa=" + $('#input_NoCAPA').val() + "&Type=Material/Produk",
            async: true,
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var result = JSON.parse(data);
                var $ = go.GraphObject.make;
                myDiagram =
                    $(go.Diagram, "DiagMaterial",
                        {
                            "undoManager.isEnabled": true,
                            contentAlignment: go.Spot.Center,
                            layout: $(go.TreeLayout, // specify a Diagram.layout that arranges trees
                                { angle: 90, layerSpacing: 35 })

                        });


                myDiagram.nodeTemplate =
                    $(go.Node, "Horizontal",
                        { background: "#44CCFF" },
                        $(go.TextBlock, "Default Text",
                            {
                                margin: 10, width: 75, height: 50, stroke: "white", font: "bold 16px sans-serif", textAlign: "center", wrap: go.TextBlock.WrapFit,
                                verticalAlignment: go.Spot.Center
                            },
                            new go.Binding("text", "type")),
                        $(go.TextBlock, "Default Text",
                            {
                                margin: 10, stroke: "white", font: "bold 16px sans-serif", textAlign: "center", wrap: go.TextBlock.WrapFit,
                                verticalAlignment: go.Spot.Center
                            },
                            new go.Binding("text", "desc"))
                    );

                myDiagram.model = new go.TreeModel(result);
            }
        });
    }

    function GetRootLingkungan() {
        $.ajax({
            type: "POST",
            url: "../Koordinator/GetRoot?NoCapa=" + $('#input_NoCAPA').val() + "&Type=Lingkungan",
            dataType: 'json',
            async: true,
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var result = JSON.parse(data);
                var $ = go.GraphObject.make;
                myDiagram =
                    $(go.Diagram, "DiagLingkungan",
                        {
                            "undoManager.isEnabled": true,
                            contentAlignment: go.Spot.Center,
                            layout: $(go.TreeLayout, // specify a Diagram.layout that arranges trees
                                { angle: 90, layerSpacing: 35 })
                        });


                myDiagram.nodeTemplate =
                    $(go.Node, "Horizontal",
                        { background: "#44CCFF" },
                        $(go.TextBlock, "Default Text",
                            {
                                margin: 10, width: 75, height: 25, stroke: "white", font: "bold 16px sans-serif", textAlign: "center", wrap: go.TextBlock.WrapFit,
                                verticalAlignment: go.Spot.Center
                            },
                            new go.Binding("text", "type")),
                        $(go.TextBlock, "Default Text",
                            {
                                margin: 10, stroke: "white", font: "bold 16px sans-serif", textAlign: "center", wrap: go.TextBlock.WrapFit,
                                verticalAlignment: go.Spot.Center
                            },
                            new go.Binding("text", "desc"))
                    );

                myDiagram.model = new go.TreeModel(result);
            }
        });
    }

    function GetRootMesin() {
        $.ajax({
            type: "POST",
            url: "../Koordinator/GetRoot?NoCapa=" + $('#input_NoCAPA').val() + "&Type=Mesin",
            dataType: 'json',
            async: true,
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var result = JSON.parse(data);
                var $ = go.GraphObject.make;

                myDiagram =
                    $(go.Diagram, "DiagMesin",
                        {
                            "undoManager.isEnabled": true,
                            contentAlignment: go.Spot.Center,
                            layout: $(go.TreeLayout, // specify a Diagram.layout that arranges trees
                                { angle: 90, layerSpacing: 35 })
                        });


                myDiagram.nodeTemplate =
                    $(go.Node, "Horizontal",
                        { background: "#44CCFF" },
                        $(go.TextBlock, "Default Text",
                            {
                                margin: 10, width: 75, height: 25, stroke: "white", font: "bold 16px sans-serif", textAlign: "center", wrap: go.TextBlock.WrapFit,
                                verticalAlignment: go.Spot.Center
                            },
                            new go.Binding("text", "type")),
                        $(go.TextBlock, "Default Text",
                            {
                                margin: 10, stroke: "white", font: "bold 16px sans-serif", textAlign: "center", wrap: go.TextBlock.WrapFit,
                                verticalAlignment: go.Spot.Center
                            },
                            new go.Binding("text", "desc"))
                    );

                myDiagram.model = new go.TreeModel(result);
            }
        });
    }

    function GetRootMetode() {
        $.ajax({
            type: "POST",
            url: "../Koordinator/GetRoot?NoCapa=" + $('#input_NoCAPA').val() + "&Type=Metode",
            dataType: 'json',
            async: true,
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var result = JSON.parse(data);
                var $ = go.GraphObject.make;

                myDiagram =
                    $(go.Diagram, "DiagMetode",
                        {
                            "undoManager.isEnabled": true,
                            contentAlignment: go.Spot.Center,
                            layout: $(go.TreeLayout, // specify a Diagram.layout that arranges trees
                                { angle: 90, layerSpacing: 35 })
                        });


                myDiagram.nodeTemplate =
                    $(go.Node, "Horizontal",
                        { background: "#44CCFF" },
                        $(go.TextBlock, "Default Text",
                            {
                                margin: 10, width: 75, height: 25, stroke: "white", font: "bold 16px sans-serif", textAlign: "center", wrap: go.TextBlock.WrapFit,
                                verticalAlignment: go.Spot.Center
                            },
                            new go.Binding("text", "type")),
                        $(go.TextBlock, "Default Text",
                            {
                                margin: 10, stroke: "white", font: "bold 16px sans-serif", textAlign: "center", wrap: go.TextBlock.WrapFit,
                                verticalAlignment: go.Spot.Center
                            },
                            new go.Binding("text", "desc"))
                    );

                myDiagram.model = new go.TreeModel(result);
            }
        });
    }

    function GetAllRoot() {
        GetRootManusia();
        GetRootMaterial();
        GetRootLingkungan();
        GetRootMesin();
        GetRootMetode();
    }

    function RemoveInputField(kategori) {
        $('#TxtDeskripsi' + kategori).val("");
        $('#duedate_' + kategori.toLowerCase()).val("");
        $('#Departemen' + kategori + '_DDL').val("-").trigger("change");
        $('#TxtAreaLain' + kategori).val("");
        $('input[name="Potensi"]').prop("checked", false);
    }

    function RemoveModalInput() {
        $('#TxtPotensiKegagalan').val("");
        $('#TxtDampak').val("");
        $('#TxtSpesifikasi').val("");
        $('#TxtPenyebabPotensial').val("");
        $('#TxtMPenyebabPotensial').val("");
        $('#TxtMPotensi_KLMD').val("");
        $('#Severity_DDL').val("-").trigger('change');
        $('#Likelihood_DDL').val("-").trigger('change');
        $('#Detectability_DDL').val("-").trigger('change');
        $('#TxtRPN').val("");
        $('#TxtRiskLevel').val("");
        $('#Target_DDL').val("").trigger('change');
        $('#TxtMPotensi_K').val("");
        $('#TxtMPenyebab_P').val("");
        $('#TxtDPotensi_K').val("");
        $('#Severity2_DDL').val("-").trigger('change');
        $('#Likelihood2_DDL').val("-").trigger('change');
        $('#Detectability2_DDL').val("-").trigger('change');
        $('#TxtRPN2').val("");
        $('#TxtRiskLevel2').val("");
        //$('#TxtPICName').val("");
        //$('#TxtPIC').val("");
        $('#TxtLainnya').val("");
        $('#DueDate_Kajian').val("");
        $('#Div_KajianResikoModal').prop('hidden', true);
        $('#KajianResikoModal').modal('hide');
    }

    function HideDeleteButton() {
        // variable isHide berada di partial view
        return isHide = true;
    }

    $(document).ready(function () {
        
        //isHide = false;
        GetAllRoot();        
        checkStatusCAPA();
        KajianResikoDDL();
        //HideDeleteButton();
        DeleteKajianResiko();
        UnhideKajianResikoModal();
        getDDLDeptKajianResiko();
        getVendorDDL();

        //console.log(rootcauses);

        $('#btn_AddPerbaikan').click(function () {
            var dto = {};
            var kategori = "Perbaikan";
            var obj = rootcauses;

            $.each(obj, function (key, value) {
                if (value.WhyDesc == $('#RootCause_DDL').val()) {
                    dto = {
                        Option: 7,
                        NO_CAPA: $('#input_NoCAPA').val(),
                        Aspect: value.Aspect,
                        WhyID: value.WhyID,
                        WhyParentID: value.ParentID,
                        RootCause: value.WhyDesc,
                        Tindakan: $('#TxtDeskripsiPerbaikan').val(),
                        Pelaksana: $('#NamaPersonilPerbaikan_DDL').val(),
                        Departemen: $('#DepartemenPerbaikan_DDL').val(),
                        LineNumber: value.LineNumber,
                        DueDate: $('#duedate_perbaikan').val(),
                        NamaPersonil: $('#NamaPersonilPerbaikan_DDL option:selected').text(),
                        Email: $('#TxtEmailPerbaikan').val(),
                        Is_AreaLain: $('input[name="Potensi"]:checked').val(),
                        Create_By: $('#input_Requestor_NIK').val(),
                        Status: "Active",
                        Status_ID: 1,
                        SP: "[dbo].[SP_FORM_CAPA]"
                    }
                    return false;
                }
            });

            //console.log(dto);

            addTindakan(dto, kategori);
        });

        $('#btn_AddPencegahan').click(function () {
            var dto = {};
            var kategori = "Pencegahan";
            var obj = area_lains;
            $.each(obj, function (key, value) {
                if (value.Tindakan_Perbaikan == $('#AreaLain_DDL').val()) {
                    dto = {
                        Option: 9,
                        NO_CAPA: $('#input_NoCAPA').val(),
                        Aspect: value.WAHType_FK,
                        WhyID: value.WhyID,
                        WhyParentID: value.WhyParentID,
                        RootCause: value.Tindakan_Perbaikan,
                        AreaLain: $('#TxtAreaLainPencegahan').val(),
                        Tindakan: $('#TxtDeskripsiPencegahan').val(),
                        Pelaksana: $('#NamaPersonilPencegahan_DDL').val(),
                        Departemen: $('#DepartemenPencegahan_DDL').val(),
                        LineNumber: value.LineNumber,
                        DueDate: $('#duedate_pencegahan').val(),
                        NamaPersonil: $('#NamaPersonilPencegahan_DDL option:selected').text(),
                        Email: $('#TxtEmailPencegahan').val(),
                        Create_By: $('#input_Requestor_NIK').val(),
                        Status: "Active",
                        Status_ID: 1,
                        SP: "[dbo].[SP_FORM_CAPA]"
                    }
                    return false;
                }
            });
            //console.log(dto)
            addTindakan(dto, kategori);                        
        });

        $('#DepartemenPerbaikan_DDL').change(function () {
            $('#TxtEmailPerbaikan').val("");
            var kategori = 'Perbaikan';
            $('#Div_VendorNamePerbaikan').prop('hidden', true);

            var dept = $('#DepartemenPerbaikan_DDL').val();
            if (dept == "Others") {
                $('#Div_VendorNamePerbaikan').prop('hidden', false);
                $('#VendorPerbaikan_DDL').change(function () {
                    getPICKajianResiko(kategori);
                });
            }
            getPICKajianResiko(kategori);
        });

        $('#DepartemenPencegahan_DDL').change(function () {
            $('#TxtEmailPencegahan').val("");
            var kategori = 'Pencegahan';
            $('#Div_VendorNamePencegahan').prop('hidden', true);

            var dept = $('#DepartemenPencegahan_DDL').val();
            if (dept == "Others") {
                $('#Div_VendorNamePencegahan').prop('hidden', false);
                $('#VendorPencegahan_DDL').change(function () {
                    getPICKajianResiko(kategori);
                });
            }
            getPICKajianResiko(kategori);
        });

        $('#Severity_DDL').change(function () {
            realtimeCalculation();
            UnhideKajianResikoModal();
        });

        $('#Likelihood_DDL').change(function () {
            realtimeCalculation();
            UnhideKajianResikoModal();
        });

        $('#Detectability_DDL').change(function () {
            realtimeCalculation();
            UnhideKajianResikoModal();
        });

        $('#Severity2_DDL').change(function () {
            realtimeCalculation();
        });

        $('#Likelihood2_DDL').change(function () {
            realtimeCalculation();
        });

        $('#Detectability2_DDL').change(function () {
            realtimeCalculation();
        });

        $("#isParent").change(function () {
            if ($("#isParent").prop('checked') == true) {
                $("#Div_WhyParent").prop('hidden', true);
                return;
            }
            $("#Div_WhyParent").prop('hidden', false);
        });

        var isValid = false;
        $('#btn_AddWhy').click(function () {
            dto = {
                Option: 3,
                NO_CAPA: $('#input_NoCAPA').val(),
                Aspect: $('#Aspect_DDL').val(),
                WAH: $('#WAH_DDL').val(),
                isParent: ($("#isParent[type='checkbox']:checked").val() == "Yes") ? (1) : (0),
                WHY_Parent: $('#WhyParent_DDL').val(),
                WHY: $('#TxtWhy').val(),
                SP: "[dbo].[SP_FORM_CAPA]"
            }

            $.each(dto, function (key, value) {
                if (dto.isParent == 1) {
                    if (key != "isParent" && key != "WHY_Parent") {
                        if (value == null || value == "") {
                            isValid = false;
                            return false;
                        }
                    }
                } else {
                    if (key != "isParent") {
                        if (value == null || value == "") {
                            isValid = false;
                            return false;
                        }
                    }
                }
                isValid = true;
            });

            if (isValid) {
                $.ajax({
                    url: 'AddWhy',
                    type: 'post',
                    data: JSON.stringify(dto),
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        if (JSON.parse(data)[0].VALID == "VALID") {
                            Swal.fire(
                                'Success',
                                'Data berhasil di-input.',
                                'success'
                            ).then((result) => {
                                if (result.value) {
                                    $('#TxtWhy').val("");
                                    status++;
                                    retrieveData();
                                    getWhyParent();
                                    GetAllRoot();
                                }
                            })
                        } else {
                            Swal.fire(
                                'Failed',
                                'Data tidak berhasil di-input.',
                                'error'
                            )
                        }
                    },
                    error: function (ex) {
                        alert(JSON.stringify(ex));
                    }
                });
            } else {
                Swal.fire(
                    'Maaf',
                    'Input tidak boleh kosong.',
                    'warning'
                )
            }
        });

        $('#btn_AddKondisi').click(function () {
            var valid = false;
            dto = {
                Option: 1,
                NO_CAPA: $('#input_NoCAPA').val(),
                Aspect: $('#Select_AspectKondisi').val(),
                WSBH: $('#TxtWSBH').val(),
                WAH: $('#TxtWAH').val(),
                Status: $("input[name=optradio]:checked").val(),
                SP: "[dbo].[SP_FORM_CAPA]"
            }

            $.each(dto, function (key, value) {
                if (value == '' || value === undefined) {
                    return valid = false;
                } else {
                    valid = true;
                }
            });

            if (valid) {
                $.ajax({
                    url: 'AddKondisi',
                    type: 'post',
                    data: JSON.stringify(dto),
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',

                    success: function (data) {
                        //console.log(data);
                        if (JSON.parse(data)[0].VALID == 'VALID') {
                            Swal.fire(
                                'Success',
                                'Data berhasil di-input.',
                                'success'
                            ).then((result) => {
                                if (result.value) {
                                    $('#TxtWSBH').val("");
                                    $('#TxtWAH').val("");
                                    $('input[name="optradio"]').prop('checked', false);
                                    getTable(true);
                                }
                            })
                        } else {
                            Swal.fire(
                                'Failed',
                                'Data tidak berhasil di-input.',
                                'error'
                            )
                        }
                        //$.each(data, function (key, value) {
                        //    if (Object.keys(value)[3] == "Aspect") {
                        //        if ($("#Aspect_DDL option:contains(" + value.Aspect + ")").val() != value.Aspect) {
                        //            $('#Aspect_DDL').append(new Option(value.Aspect, value.Aspect));
                        //        }
                        //    }
                        //    if (Object.keys(value)[5] == "WAH")
                        //        $('#WAH_DDL').append(new Option(value.WAH, value.WAH));
                        //});
                    },
                    error: function (ex) {
                        alert(JSON.stringify(ex));
                    }
                });
            } else {
                Swal.fire(
                    'Maaf',
                    'Input tidak boleh kosong.',
                    'warning'
                )
            }
        });

        $(document).on("click", "#Tbl_Analisa a.delete", function () {
            var temp = [];
            var columns = $(this).closest('tr').find('td');
            $.each(columns, function (i, item) {
                var obj = {};
                obj.name = item.innerHTML;
                temp.push(obj);
                //console.log(i + item.innerHTML);
                //console.log(arr[i]);
            });

            var dto = {
                Option: 5,
                No_CAPA: $('#input_NoCAPA').val(),
                WAH: temp[3].name,
                WSBH: temp[2].name,
                Aspect: temp[1].name,
                SP: "[dbo].[SP_FORM_CAPA]"
            }

            $.ajax({
                url: 'DeleteKondisi',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify(dto),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    getTable();
                    return true;
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        });

        var countYes = 0;
        var countNo = 0;
        $('input[name="Potensi"]').click(function () {
            if ($('input[name="Potensi"]:checked').val() == 'Yes') {
                countNo = 0;
                countYes++;
            } else {
                countYes = 0;
                countNo++;
            }
            if (countYes == 2 || countNo == 2) {
                countYes = 0;
                countNo = 0;
                $('input[name="Potensi"]').prop("checked", false);
            }

        });

        $('input[name="optradio"]').click(function () {
            if ($('input[name="optradio"]:checked').val() == 'OK') {
                countNo = 0;
                countYes++;
            } else {
                countYes = 0;
                countNo++;
            }
            if (countYes == 2 || countNo == 2) {
                countYes = 0;
                countNo = 0;
                $('input[name="optradio"]').prop("checked", false);
            }

        });

        $('#btn_AddKajian').click(function () {
            recTindakan(0);
            $('#TxtPIC').val(values.Nama_Personil);
            $('#TxtPICName').val(values.FullName);
        });

        $('#btn_KajianResiko').click(function () {
            //recTindakan(0);
            //if ($('#TxtRiskLevel2').val() == 'High' || $('#TxtRiskLevel2').val() == 'Very High') {
            //    Swal.fire(
            //        'Maaf',
            //        'Risk Level masih tinggi.',
            //        'warning'
            //    )
            //} else {
            var valid = true;
            var pic = "";
            if ($('#Severity_DDL').val() == 10 || $('#TxtRiskLevel').val() == 'High' || $('#TxtRiskLevel').val() == 'Very High') {
                pic = $('#TxtPIC').val();
            }

            dto = {
                Model: {
                    RecordID: values.RecordID,
                    NO_CAPA: $('#input_NoCAPA').val(),
                    Tipe: values.Tipe,
                    Tindakan: $('#RootCause_KajianResikoDDL').val(),
                    P_Kegagalan: $('#TxtPotensiKegagalan').val(),
                    Spek: $('#TxtSpesifikasi').val(),
                    Dampak: $('#TxtDampak').val(),
                    Severity: $('#Severity_DDL').val(),
                    Penyebab: $('#TxtPenyebabPotensial').val(),
                    M_Penyebab: $('#TxtMPenyebabPotensial').val(),
                    Likelihood: $('#Likelihood_DDL').val(),
                    M_PKegagalan_LMD: $('#TxtMPotensi_KLMD').val(),
                    Detectability: $('#Detectability_DDL').val(),
                    RPN: $('#TxtRPN').val(),
                    RiskLevel: $('#TxtRiskLevel').val(),
                    Target: $('#Target_DDL').val(),
                    M_PKegagalan: $('#TxtMPotensi_K').val(),
                    Severity2: $('#Severity2_DDL').val(),
                    P_MPenyebab: $('#TxtMPenyebab_P').val(),
                    Likelihood2: $('#Likelihood2_DDL').val(),
                    P_MDPKegagalan: $('#TxtDPotensi_K').val(),
                    Detectability2: $('#Detectability2_DDL').val(),
                    RPN2: $('#TxtRPN2').val(),
                    RiskLevel2: $('#TxtRiskLevel2').val(),
                    PIC: pic,
                    DueDate: $('#DueDate_Kajian').val(),
                    Lainnya: $('#TxtLainnya').val(),
                    EmpID: $('#input_Requestor_NIK').val()
                }
            }

            elementID = {
                NO_CAPA: '#input_NoCAPA',
                Tindakan: '#RootCause_KajianResikoDDL',
                P_Kegagalan: '#TxtPotensiKegagalan',
                Spek: '#TxtSpesifikasi',
                Dampak: '#TxtDampak',
                Severity: '#Severity_DDL',
                Penyebab: '#TxtPenyebabPotensial',
                M_Penyebab: '#TxtMPenyebabPotensial',
                Likelihood: '#Likelihood_DDL',
                M_PKegagalan_LMD: '#TxtMPotensi_KLMD',
                Detectability: '#Detectability_DDL',
                RPN: '#TxtRPN',
                RiskLevel: '#TxtRiskLevel',
                Target: '#Target_DDL',
                M_PKegagalan: '#TxtMPotensi_K',
                Severity2: '#Severity2_DDL',
                P_MPenyebab: '#TxtMPenyebab_P',
                Likelihood2: '#Likelihood2_DDL',
                P_MDPKegagalan: '#TxtDPotensi_K',
                Detectability2: '#Detectability2_DDL',
                RPN2: '#TxtRPN2',
                RiskLevel2: '#TxtRiskLevel2',
                DueDate: '#DueDate_Kajian',
                Lainnya: '#TxtLainnya'
            }

            var limit = (dto.Model.Severity == 10 || dto.Model.RiskLevel == "High" || dto.Model.RiskLevel == "Very High") ? (25) : (14);

            //Delete dto.Model over than 14 properties.
            var i = 0;
            for (var property in dto.Model) {
                if (limit == 14) {
                    if (i > 14 && i < 26) {
                        if (elementID[property] != undefined) {
                            $(elementID[property]).val("");
                            if (i == 17 || i == 19 || i == 21) { //ini index array untuk dropdownlist Severity2, Likelihood2, dan Detectability2
                                $(elementID[property]).val('-');
                            }

                        }
                        delete dto.Model[property];
                    }
                } else {
                    if ($('#TxtRiskLevel2').val() == 'High' || $('#TxtRiskLevel2').val() == 'Very High') {
                        valid = false;
                        return Swal.fire(
                            'Maaf',
                            'Risk Level masih tinggi.',
                            'warning'
                        )
                    }
                }
                i++;
            }

            var count = 0;
            //console.log("limit : " + limit);
            $.each(dto.Model, function (key, value) {
                if (key === "M_PKegagalan" || key === "P_MPenyebab" || key == "P_MDPKegagalan") {
                    if (dto.Model.Severity == 10 || dto.Model.RiskLevel == "High" || dto.Model.RiskLevel == "Very High") {
                        if (dto.Model.M_PKegagalan == "" && dto.Model.P_MPenyebab == "" && dto.Model.P_MDPKegagalan == "") {
                            Swal.fire(
                                'Maaf',
                                'Input field "Menghilangkan Potensi Kegagalan / Penyimpangan" atau "Perbaikan untuk mengatasi Penyebab Potensial" atau "Perbaikan untuk meningkatkan deteksi potensi kegagalan" wajib diisi salah satu.',
                                'warning'
                            )
                            valid = false;
                            return false;
                        }
                    }
                    count++;
                    return;
                } else {
                    //console.log(key + ": " + value);
                    if (value == "" || value == null) {
                        //console.log(dto.Model);
                        if (count <= limit) {

                            var label;
                            if (count == 13 || count == 14 || count == 22 || count == 23) {
                                label = "Mohon untuk mengisi nilai Severity, Likelihood, dan Detectability yang tersedia.";
                            } else {
                                label = 'Input field "' + $("label[for='" + elementID[Object.keys(dto.Model)[count]].substring(1) + "']").text() + '" Mohon di isi.';
                            }
                            Swal.fire(
                                'Maaf',
                                label,
                                'warning'
                            )
                            valid = false;
                            return false;
                        }
                        //else if (dto.Model.DueDate == "") {
                        //    Swal.fire(
                        //        'Maaf',
                        //        'Mohon untuk mengisi DueDate PIC Treatment.',
                        //        'warning'
                        //    )
                        //    valid = false;
                        //    return false;
                        //}
                    }
                }
                count++;
                valid = true;
            });

            //console.log(valid)

            if (valid) {
                $.ajax({
                    url: 'AddKajian',
                    type: 'post',
                    dataType: 'json',
                    data: JSON.stringify(dto),
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        if (data != null) {
                            Swal.fire(
                                'Success',
                                'Data berhasil di-input.',
                                'success'
                            ).then(function (result) {
                                if (result.value) {
                                    //close modal
                                    RemoveModalInput();
                                    // fetch to table
                                    TableKajian(true);
                                }
                            });
                        }
                    },
                    error: function (ex) {
                        alert(JSON.stringify(ex));
                    }
                });
            }
        });

        $("#btn_Submit").click(function () {
            //window.location.replace('/PendingTask/TaskList');
            var isValid = false;

            $.ajax({
                url: 'SubmitToAtasanPIC',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify({
                    Model: {
                        NO_CAPA: $('#input_NoCAPA').val(),
                        Option: 15,
                        Create_By: $('#input_Requestor_NIK').val()
                    }
                }),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    isValid = JSON.parse(data)[0].IS_VALID;
                    if (isValid) {
                        $.ajax({
                            url: 'SubmitToAtasanPIC',
                            type: 'post',
                            dataType: 'json',
                            data: JSON.stringify({
                                Model: {
                                    NO_CAPA: $('#input_NoCAPA').val(),
                                    Option: 12,
                                    Create_By: $('#input_Requestor_NIK').val()
                                }
                            }),
                            contentType: 'application/json; charset=utf-8',
                            success: function (data) {
                                var mData = JSON.parse(data);
                                $.each(mData, function (key, value) {
                                    var attr = Object.keys(value)[0];
                                    var icon;
                                    if (attr == "WAITING")
                                        icon = 'warning';
                                    else if (attr == 'SUCCESS')
                                        icon = 'success';
                                    else
                                        icon = 'error';
                                    Swal.fire(
                                        attr,
                                        value[attr],
                                        icon
                                    ).then(function (result) {
                                        if (result.value) {
                                            window.location.href = '/PendingTask/TaskList';
                                        }
                                    });
                                    return false;
                                });
                            },
                            error: function (ex) {
                                alert(JSON.stringify(ex));
                            }
                        });
                    } else {
                        Swal.fire(
                            'WARNING',
                            'Masih ada Tindakan yang belum dikaji.',
                            'warning'
                        );
                    }
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        });

        $('#btn_Request').click(function () {
            window.open('/Koordinator/CreateCAPA?NoCAPA=' + $('#input_NoCAPA').val());
        });

    });
</script>
