
@{
    ViewBag.Title = "VerifikasiPelaksanaCAPA";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-body">

    <div class="row page-titles mx-0">
        <div class="col p-md-0">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="javascript:void(0)">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="javascript:void(0)">Koordinator</a></li>
                <li class="breadcrumb-item active"><a href="javascript:void(0)">Verifikasi Pelaksanaan CAPA</a></li>
            </ol>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="form-group mb-2 col-sm-3">
                                <label class="m-t-20">Tanggal</label>
                                <input type="text" id="date-format" class="form-control form-control-sm" value="@DateTime.Today.ToShortDateString()" readonly>
                            </div>
                            <div class="form-group mb-2 col-sm-3">
                                <label class="m-t-40">User Login</label>
                                <input class="form-control form-control-sm" type="text" id="input_Requestor" value="@Request.RequestContext.HttpContext.Session["FullName"]" readonly>
                            </div>
                            <div class="form-group mb-2 col-sm-3">
                                <label class="m-t-20">Nomor CAPA</label>
                                <input class="form-control form-control-sm" type="text" id="input_NoCAPA" value="@Request.QueryString["NoCAPA"]" readonly />
                            </div>
                            <div class="form-group mb-2 col-sm-3">
                                <label class="m-t-40">Departemen</label>
                                <input class="form-control form-control-sm" type="text" id="input_Departemen" value="@Request.RequestContext.HttpContext.Session["Departemen"]" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Verifikasi Pelaksanaan CAPA</h4>
                        <p class="text-muted">Apakah ada CAPA yang serupa dengan CAPA yang sedang di Verifikasi?</p>
                        <div class="form-group">
                            <div class="form-check form-check-inline">
                                <label class="form-check-label">
                                    <input type="checkbox" class="form-check-input" name="checkboxradio" value="Ada" checked onclick="onlyOne(this)">Ada
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <label class="form-check-label">
                                    <input type="checkbox" class="form-check-input" name="checkboxradio" value="Tidak" onclick="onlyOne(this)">Tidak Ada
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                @Html.Partial("../Koordinator/TriggerCAPA", "KoordinatorController")

                @*<div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered zero-configuration dataTable " id="Tbl_VerPelaksanaCAPA">
                    <thead>
                        <tr>
                            <th>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Action&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                            <th>Hasil&nbsp;Tindakan&nbsp;Perbaikan&nbsp;yang&nbsp;Dilakukan</th>
                            <th>Pelaksana&nbsp;Tindakan&nbsp;Perbaikan</th>
                            <th>Superior</th>
                            <th>Upload&nbsp;Bukti&nbsp;Tidakan Perbaikan&nbsp;CAPA</th>
                            <th>Hasil&nbsp;Tindakan&nbsp;Pencegahan&nbsp;yang&nbsp;Sudah&nbsp;Dilakukan</th>
                            <th>Pelaksana&nbsp;Tindakan&nbsp;Pencegahan</th>
                            <th>Superior</th>
                            <th>Bukti&nbsp;Tindakan Pencegahan&nbsp;CAPA</th>
                            <th>Treatment&nbsp;Plan&nbsp;Kajian&nbsp;Risiko</th>
                            <th>Pelaksana&nbsp;Treatment&nbsp;Plan</th>
                        </tr>
                    </thead>
                    <tbody id="Tbl_TaskList">
                    </tbody>
                </table>
            </div>
        </div>
        </div>*@
                <div class="card">
                    <div class="card-body">
                        <div class="row form-group">
                            <div class="col-md-12">
                                <h4 class="card-title">Root cause</h4>
                                <textarea type="text" class="form-control" id="txtRootCausePerbaikan" disabled></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Tindakan Perbaikan</h4>
                        <form id="formPerbaikan">

                            <div class="row form-group">
                                <div class="col-sm-6">
                                    <select class="form-control select2" name="ddlPerbaikan" id="ddlPerbaikan" required>
                                    </select>
                                </div>
                            </div>

                            <div class="row form-group">
                                <div class="col-md-6">
                                    <label class="m-t-40">Ususlan tindakan perbaikan</label>
                                    <div class="input-group mb-3">
                                        <textarea type="text" id="txtUsulanPerbaikan" class="form-control" disabled></textarea>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <label class="m-t-40">Pelaksana tindakan perbaikan</label>
                                    <div class="input-group mb-3">
                                        <input type="text" id="txtPelaksanaPerbaikan" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <label class="m-t-40">Superior</label>
                                    <div class="input-group mb-3">
                                        <input type="text" id="txtSuperiorPerbaikan" class="form-control" disabled>
                                    </div>
                                </div>
                            </div>


                            <div class="row form-group-sm">
                                <div class="col-md-6">
                                    <label class="m-t-40">Hasil tindakan perbaikan yang sudah dilakukan<span style="color: red">*</span></label>
                                    <div class="input-group mb-3">
                                        <textarea type="text" id="txtHasilPerbaikan" class="form-control" disabled></textarea>
                                    </div>
                                </div>
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-20">Due date<span style="color: red">*</span></label>
                                    <input type="text" id="dueDatePerbaikan" class="form-control form-control-sm" disabled>
                                </div>
                            </div>
                            <br />
                           
                            <div class="table-responsive">
                                <table class="table table-bordered zero-configuration" id="tblAttachmentPerbaikan">
                                    <thead>
                                        <tr>
                                            <th>Nama File</th>
                                            <th hidden></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyAttachmentPerbaikan">
                                        <tr>
                                            <td>Belum ada file terpilih</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                </div>


                <div class="card" id="Div_Pencegahan">
                    <div class="card-body">
                        <h4 class="card-title">Tindakan Pencegahan</h4>
                        <form>

                            <div class="row form-group">
                                <div class="col-md-6">
                                    <label class="m-t-20">Ususlan tindakan pencegahan<span style="color: red">*</span></label>
                                    <textarea type="text" class="form-control" id="txtUsulanPencegahan"  disabled></textarea>
                                </div>
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-20">Due Date</label>
                                    <input type="text" id="dueDatePencegahan" class="form-control form-control-sm" disabled>
                                </div>
                            </div>

                            <div class="row form-group">
                                <div class="col-md-6">
                                    <label class="m-t-40">Hasil tindakan Pencegahan yang sudah dilakukan</label>
                                    <div class="input-group mb-3">
                                        <input type="text" id="txtHasilPencegahan" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="m-t-40">Pelaksana tindakan pencegahan</label>
                                    <div class="input-group mb-3">
                                        <input type="text" id="txtPelaksanaPencegahan" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="m-t-40">Superior</label>
                                    <div class="input-group mb-3">
                                        <input type="text" id="txtSuperiorPencegahan" class="form-control" disabled>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-bordered zero-configuration" id="tblAttachmentPerbaikan">
                                    <thead>
                                        <tr>
                                            <th>Nama File</th>
                                            <th hidden></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyAttachmentPerbaikan">
                                        <tr>
                                            <td>Belum ada file terpilih</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>


                        </form>
                    </div>
                </div>

                <div class="card" id="Div_Treatment">
                    <div class="card-body">
                        <h4 class="card-title">Tindakan Treatment</h4>
                        <form>

                            <div class="row form-group">
                                <div class="col-md-6">
                                    <label class="m-t-20">Ususlan tindakan treatment<span style="color: red">*</span></label>
                                    <textarea type="text" class="form-control"  disabled></textarea>
                                </div>
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-20">Due Date</label>
                                    <input type="date" id="date-format" class="form-control form-control-sm">
                                </div>
                            </div>

                            <div class="row form-group">
                                <div class="col-md-6">
                                    <label class="m-t-40">Hasil tindakan treatment yang sudah dilakukan</label>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="m-t-40">Pelaksana tindakan treatment</label>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="m-t-40">Superior</label>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" disabled>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-bordered zero-configuration" id="tblAttachmentPerbaikan">
                                    <thead>
                                        <tr>
                                            <th>Nama File</th>
                                            <th hidden></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyAttachmentPerbaikan">
                                        <tr>
                                            <td>Belum ada file terpilih</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>

<script>
    var dataPerbaikan;
    var noCAPA = getQueryStrings()["NoCAPA"];
    var nik = '@Request.RequestContext.HttpContext.Session["NIK"]';


    function getQueryStrings() {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for (var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }

    $(document).ready(function () {
        FindPerbaikanVerifikasi();
        $('#Div_Treatment').hide();
        $('#Div_Pencegahan').hide();
    });

    $(document).ready(function () {
        
        PopulateDDLPerbaikan();
        $("#ddlPerbaikan").change(function () {
            LoadPerbaikan();
        });
    });

    function onlyOne(checkbox) {
        var checkboxes = document.getElementsByName('checkboxradio')
        checkboxes.forEach((item) => {
            if (item !== checkbox) item.checked = false
        })



        var t_cek = document.querySelector('input[type=checkbox][name=checkboxradio]:checked').value;
        alert(t_cek);

        if (t_cek === 'Ada') {
            $('#Trigger_CAPA').prop('disabled', false);

        }

        if (t_cek === 'Tidak')    {
            $('#Trigger_CAPA').prop('disabled', true);
            $('#Linked_Oracle').prop('hidden', true);
            $('#Linked_CCC').prop('hidden', true);
            $('#Linked_Deviation').prop('hidden', true);
            $('#Linked_Renew').prop('hidden', true);

            getDDL();
        }
    }

    function FindPerbaikanVerifikasi() {

        var dto = {
            Kategori: "Verifikasi Perbaikan",
            NO_CAPA: noCAPA,
            NIK: "",
            Status: "Active"
        }
        $.ajax({
            url: "../Koordinator/GetVerfifikasiData",
            type: "POST",
            async: false,
            dataType: "json",
            data: JSON.stringify(dto),
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                var result = JSON.parse(data);
                dataPerbaikan = result;
                console.log(dataPerbaikan);
                PopulateDDLPerbaikan();
            }, error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function PopulateDDLPerbaikan() {
        $('#ddlPerbaikan').empty();
        let t_cek = ''
        for (i = 0; i < dataPerbaikan.length; i++) {
            idx = i + 1;
            if (t_cek === dataPerbaikan[i].TINDAKAN_PERBAIKAN) {

            }
            else {
                t_cek = dataPerbaikan[i].TINDAKAN_PERBAIKAN;
                $('#ddlPerbaikan').append('<option disabled selected hidden class="dropdown-header">Tindakan Perbaikan</option>');
                $('#ddlPerbaikan').append('<option value="' + dataPerbaikan[i].IDPerbaikan + '">' + dataPerbaikan[i].TINDAKAN_PERBAIKAN + '</option>');
                
            }
            
        }
    }


    function LoadPerbaikan() {
        
        let idx = $('#ddlPerbaikan').val();
        let idPen = dataPerbaikan[idx].IDPencegahan;
        

        
        $('#txtRootCausePerbaikan').val(dataPerbaikan[idx].WhyDesc);
        $('#txtUsulanPerbaikan').val(dataPerbaikan[idx].WhyDesc);
        $('#txtPelaksanaPerbaikan').val(dataPerbaikan[idx].Pelaksana_Perbaikan);
        $('#txtSuperiorPerbaikan').val(dataPerbaikan[idx].SuperiorPerbaikan);
        $('#txtTindakanPerbaikan').val(dataPerbaikan[idx].Hasil_Perbaikan);
        $('#dueDatePerbaikan').val(dataPerbaikan[idx].DUE_DATE_PERBAIKAN);
        $('#txtHasilPerbaikan').val(dataPerbaikan[idx].Hasil_Perbaikan);

        alert(dataPerbaikan[idx].IDPencegahan)
        if (dataPerbaikan[idx].IDPencegahan == null) {
            alert('null');
            $('#Div_Pencegahan').hide();
        }
        else {
            alert('not null');
            $('#Div_Pencegahan').show();

            $('#txtUsulanPencegahan').val(dataPerbaikan[idx].TINDAKAN_PENCEGAHAN);
            $('#dueDatePencegahan').val(dataPerbaikan[idx].DUE_DATE_PENCEGAHAN);
            $('#txtHasilPencegahan').val(dataPerbaikan[idx].Hasil_Pencegahan);
            $('#txtPelaksanaPencegahan').val(dataPerbaikan[idx].Pelaksana_Pencegahan);
            $('#txtSuperiorPencegahan').val(dataPerbaikan[idx].SuperiorPencegahan);
            $('#txtHasilPencegahan').val(dataPerbaikan[idx].Hasil_Pencegahan);
            
        }
        
    }
</script>

