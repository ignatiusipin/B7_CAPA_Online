
@{
    ViewBag.Title = "Koordinator4";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using B7_CAPA_Online.Models
@model DALModel


<style>
    @@media (min-width: 768px) {
        .modal-xl {
            width: 900%;
            max-width: 1300px;
        }
    }
</style>

<div class="content-body">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">Koordinator</h4>
            <form>
                <div class="row">
                    <div class="form-group mb-2 col-sm-3">
                        <label class="m-t-20">Tanggal</label>
                        <input type="text" id="date-format" class="form-control form-control-sm" value="@DateTime.Today.ToShortDateString()" readonly>
                    </div>
                    <div class="form-group mb-2 col-sm-3">
                        <label class="m-t-40">Requestor</label>
                        <input class="form-control form-control-sm" type="text" id="input_Requestor" readonly>
                    </div>
                    <div class="form-group mb-2 col-sm-3">
                        <label class="m-t-20">Nomor CAPA</label>
                        <input class="form-control form-control-sm" type="text" id="input_NoCAPA" value="@Request.QueryString["CAPA"]" readonly />
                        <input class="form-control form-control-sm" type="text" id="input_REG_ID" value="@Request.QueryString["REG"]" hidden />
                    </div>
                    <div class="form-group mb-2 col-sm-3">
                        <label class="m-t-40">Departemen</label>
                        <input class="form-control form-control-sm" type="text" id="input_Departemen" readonly>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <form>
                <div class="row">
                    <div class="form-group mb-2 col-sm-12">
                        <label class="m-t-40">
                            Apakah terjadi penyimpangan serupa pada rentang waktu yang telah ditetapkan?
                        </label>
                    </div>
                </div>
                <div class="row">
                    <label class="m-t-20" style="margin-left:15px;"> <b>Ya</b> </label>
                    <input type='radio' id="Devi_Yes" name="Devi_Radio" value="Yes" style="margin-left:15px;" />
                    <label class="m-t-20" style="margin-left:15px;"> <b>Tidak</b> </label>
                    <input type='radio' id="Devi_No" name="Devi_Radio" value="no" style="margin-left:15px;" />
                </div>
                <div class="row" id="Deviation" hidden>
                    <table class="table table-striped table-bordered zero-configuration" id="Tbl_Devi">
                        <thead>
                            <tr>
                                <th>EmpID</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn btn-outline-dark" type="button" data-toggle="modal" data-target="#link_Deviation" data-backdrop="static" data-keyboard="false">Browse</button>
                </div>
                <div class="row">
                    <div class="form-group mb-2 col-sm-12">
                        <label class="m-t-40">
                            Apakah ada keluhan pelanggan serupa pada rentang waktu yang telah ditetapkan?
                        </label>
                    </div>
                </div>
                <div class="row">
                    <label class="m-t-20" style="margin-left:15px;"> <b>Ya</b> </label>
                    <input type='radio' id="CCC_Yes" name="CCC_Radio" value="Yes" style="margin-left:15px;" />
                    <label class="m-t-20" style="margin-left:15px;"> <b>Tidak</b> </label>
                    <input type='radio' id="CCC_No" name="CCC_Radio" value="No" style="margin-left:15px;" />
                </div>
                <div class="row">
                    <table class="table table-striped table-bordered zero-configuration" id="Tbl_CCC" hidden>
                        <thead>
                            <tr>
                                <th>EmpID</th>
                                <th>EmpName</th>
                                <th>Plant</th>
                                <th>Role</th>
                                <th>Evaluator Utama</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                            </tr>
                        </tbody>
                    </table>

                    <div><input type="button" id="Browse" /></div>
                </div>
                <div class="row">
                    <div class="form-group mb-2 col-sm-12">
                        <label class="m-t-40">
                            Apakah ada temuan serupa pada rentang waktu yang telah ditetapkan?
                        </label>
                    </div>
                </div>

                <div class="row">
                    <label class="m-t-20" style="margin-left:15px;"> <b>Ya</b> </label>
                    <input type='radio' id="File_Yes" name="File_Radio" style="margin-left:15px;" value="Yes" />
                    <label class="m-t-20" style="margin-left:15px;"> <b>Tidak</b> </label>
                    <input type='radio' id="File_No" name="File_Radio" style="margin-left:15px;" value="No" />
                </div>
                <div class="row form-group-sm mb-2" id="Lampiran" hidden>
                    <div class="col-md-6">
                        <label class="m-t-20">Lampiran Terkait</label>
                        <div class="input-group mb-3">
                            <div class="custom-file">
                                <input id="TxtFileInput" type="file" name="LampiranTerkait" class="custom-file-input" multiple required">

                                <label id="TxtLampiranCount" class="custom-file-label"></label>
                            </div>
                        </div>
                    </div>
                </div>
                <br />
                <input type="button" class="btn btn-primary" id="Submit" value="Submit" />
            </form>
        </div>
    </div>
    <div class="modal fade" id="link_CCC" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Filter</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group col-md-6">
                            <label for="TxtTahunCCC" class="col-form-label">Tahun:</label>
                            <div class="input-group">
                                <select class="form-control select2 TahunCCC" name="TahunCCC" id="Tahun_DDL_CCC" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtPlantCCC" class="col-form-label">Plant:</label>
                            <div class="input-group ">
                                <select class="form-control select2" id="Plant_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtKategoriCCC" class="col-form-label">Jenis Kategori:</label>
                            <div class="input-group">
                                <select class="form-control select2" id="JenisKategori_DDL" required>
                                    <option value="JUSTIFIED">Justified</option>
                                    <option value="UNJUSTIFIED">Unjustified</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtKeluhanCCC" class="col-form-label">Jenis Keluhan:</label>
                            <div class="input-group">
                                <select class="form-control select2" id="JenisKeluhan_DDL" required>
                                    <option value="Quality">Quality</option>
                                    <option value="Health">Health</option>
                                    <option value="Promotion">Promotion</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <button type="button" class="btn btn-primary" id="btn_Search_CCC">Search</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered zero-configuration" id="Tbl_CCC">
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>No CCC</th>
                                        <th>Nama Pelanggan</th>
                                        <th>Jenis Kategori</th>
                                        <th>Jenis Keluhan</th>
                                        <th>Deskripsi Singkat</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="link_Deviation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Filter</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group col-md-6">
                            <label for="TxtTahunDeviation" class="col-form-label">Tahun:</label>
                            <div class="input-group">
                                <select class="form-control select2" name="TahunDeviation" id="Tahun_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtDepartemenDeviation" class="col-form-label">Departemen:</label>
                            <div class="input-group ">
                                <select class="form-control select2" id="DepartemenPelapor_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtKategoriDeviation" class="col-form-label">Kategori Penyimpangan:</label>
                            <div class="input-group">
                                <select class="form-control select2" id="KategoriPenyimpangan_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtJenisPenyimpangan" class="col-form-label">Jenis Penyimpangan:</label>
                            <div class="input-group">
                                <select class="form-control select2" id="JenisPenyimpangan_DDL" required>
                                    <option value="Yes">Terencana</option>
                                    <option value="No">Tidak Terencana</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <button type="button" class="btn btn-primary" id="btn_Search_Deviation">Search</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered zero-configuration" id="Tbl_Deviation">
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>No Penyimpangan</th>
                                        <th>Nama Pelapor</th>
                                        <th>Kategori Penyimpangan</th>
                                        <th>Jenis Penyimpangan</th>
                                        <th>Deskripsi Singkat</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
        <input type="text" class="btn btn-primary" id="QS_NoCAPA" value="@ViewBag.NoCAPA" hidden />
        <input type="text" class="btn btn-primary" id="QS_Status" value="@ViewBag.status" hidden />
    </div>
</div>

<script>

    $(document).ready(function () {
        getDDL();
        TahunDDL();
        $('#Tahun_DDL').select2();
        $('#AreaPIC_DDL').select2();
        $('#PIC_DDL').select2();
        var chckboxstatus = [];
        $('input[name="Devi_Radio"]').change(function () {
            if ($('input[name="Devi_Radio"]:checked').val() == 'Yes') {
                chckboxstatus[0] = "Yes";
                $('#Deviation').removeAttr('hidden');
            }
            else {
                chckboxstatus[0] = "No";
                $('#Deviation').attr("hidden", true);
                $('#link_Deviation').attr("hidden", true);
            }
        });
        $('#BrowseDev').click(function () {
            $('#link_Deviation').prop('hidden', false);
        })
        $('input[name="CCC_Radio"]').change(function () {
            if ($('input[name="CCC_Radio"]:checked').val() == 'Yes') {
                $('#Tbl_CCC').removeAttr('hidden');

                chckboxstatus[1] = "Yes";
            }
            else {
                $('#Tbl_CCC').attr("hidden", true);
                chckboxstatus[1] = "No";
            }
        });
        $('input[name="File_Radio"]').change(function () {
            if ($('input[name="File_Radio"]:checked').val() == 'Yes') {
                $('#Lampiran').removeAttr('hidden');

                chckboxstatus[2] = "Yes";
            }
            else {
                $('#Lampiran').attr("hidden", true);
                chckboxstatus[2] = "Yes";
            }
        });

        $('#TxtFileInput').change(function () {
            fileCount = this.files.length;
            var teks = (fileCount != 0) ? (fileCount + " Lampiran telah dipilih.") : ("");
            $('#TxtLampiranCount').text(teks);
        })
        $('#Submit').click(function () {

            Submit();

        });

        $('#btn_Search_Deviation').click(function () {
            dto = {
                Option: 1,
                NoCapa:"CPA/SIA/HOF/MK/0921/009",
                Departemen: $('#DepartemenPelapor_DDL').val(),
                JenisPenyimpangan: $('#JenisPenyimpangan_DDL').val(),
                Kategori: $('#KategoriPenyimpangan_DDL').val(),
                Tahun: $('#Tahun_DDL').val()
            }
            $.ajax({
                type: "POST",
                url: "ShowAddAbleDeviation",
                data: JSON.stringify(dto),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    console.log(data);
                    var table = $('#Tbl_Deviation').DataTable({
                        "pageLength": 5,
                        "lengthChange": true,
                        "searching": false,
                        "data": JSON.parse(data),
                        "select": true,
                        "scrollCollapse": true,
                        "destroy": true,
                        "columns": [
                            {
                                "data": null,
                                "defaultContent": "<input type='checkbox'/>"
                            },
                            { "data": "DEVIATION_NO" },
                            { "data": "NAMA_PELOPOR" },
                            { "data": "DEVIATION_CATEGORY" },
                            { "data": "DEVIATION_TYPE" },
                            { "data": "KET_CATEGORY" }
                        ],
                        "order": [[1, 'asc']],
                        "columndefs": [
                            {
                                "targets": 0,
                                "classname": "text-center",
                                "width": "1%"
                            },
                            {
                                "targets": 1,
                                "classname": "text-center",
                                "width": "5%"
                            },
                            {
                                "targets": 2,
                                "classname": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 3,
                                "classname": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 4,
                                "classname": "text-center",
                                "width": "4%"
                            },
                            {
                                "targets": 5,
                                "classname": "text-left",
                                "width": "15%"
                            }
                        ]
                    });
                }
            });
        });
    });
   

    function getDDL() {
        $.ajax({
            url: 'GetKoordinatorDDL',
            type: 'post',
            data: JSON.stringify({
                Option: 1,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#Trigger_CAPA').empty();
                $('#Kategori_DDL').empty();
                $('#Lokasi_DDL').empty();
                $('#Trigger_CAPA').empty();
                $('#Trigger_CAPA').append($('<option></option>').attr('value', '').text('*Pilih*'));
                $('#Kategori_DDL').append($('<option></option>').attr('value', '').text('*Pilih*'));
                $('#Lokasi_DDL').append($('<option></option>').attr('value', '').text('*Pilih*'));
                $.each(JSON.parse(data), function (key, entry) {
                    if (entry.DDL_TYPE == 'TRIGGER') {
                        $('#Trigger_CAPA').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                    }
                    if (entry.DDL_TYPE == 'KATEGORI') {
                        $('#Kategori_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                    }
                    if (entry.DDL_TYPE == 'LOKASI') {
                        $('#Lokasi_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                    }
                    $('#Trigger_CAPA').select2();
                    $('#Kategori_DDL').select2();
                    $('#Lokasi_DDL').select2();
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'GetDepartments',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Option: 8,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#DepartemenPelapor_DDL').empty();
                $.each(JSON.parse(data), function (key, entry) {
                    $('#DepartemenPelapor_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.SubDept));
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'GetKategoriPenyimpangan',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Option: 5,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#KategoriPenyimpangan_DDL').empty();
                //$('#KategoriPenyimpangan_DDL').append($('<option></option>').attr('value', '').text('*Pilih*'));
                $.each(JSON.parse(data), function (key, entry) {
                    $('#KategoriPenyimpangan_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                })
                //$('#KategoriPenyimpangan_DDL').select2();
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'GetPlantCCC',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Option: 6,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#Plant_DDL').empty();
                $.each(JSON.parse(data), function (key, entry) {
                    $('#Plant_DDL').append($('<option></option>').attr('value', entry.PlantSC).text(entry.Plant));
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

    }
    function TahunDDL() {
        var years = new Date().getFullYear();
        for (var i = years; i >= 2018; i--) {
            var trhtml = "";
            trhtml += '<Option value = "' + i + '" > ' + i;
            $('#Tahun_DDL').append(trhtml);
            $('#Tahun_DDL').select2();
        }
    }
    function Submit() {
        var formData = new FormData();
        var totalFiles = document.getElementById("TxtFileInput").files.length;
        for (var i = 0; i < totalFiles; i++) {
            var file = document.getElementById("TxtFileInput").files[i];
            formData.append("TxtFileInput", file);
            //formData.append("NoCAPA", $('#txtNoCAPA').val());
        }

        $.ajax({
            url: "InsertAttachment?NoCapa=" + $('#QS_NoCAPA').val() + "&spname=SP_Koor4&",
            type: "post",
            data: formData,
            dataType: 'json',
            contentType: false,
            processData: false,
            success: function (data) {
                $.ajax({
                    url: "DynamicController?spname=SP_Koor4&",
                    type: "post",
                    data: formData,
                    dataType: 'json',
                    contentType: "application/json;charset=utf-8",
                    success: function (data) {

                    },
                    error: function (errormessage) {
                        $('#divLoading').attr("hidden", true);
                    }
                });
            },
            error: function (errormessage) {
                $('#divLoading').attr("hidden", true);
            }
        });

    }
</script>